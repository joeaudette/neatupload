<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>

  
  <title>NeatUpload Manual</title>
</head>


<body>


<h1><a class="mozTocH1" name="mozTocId101532"></a>NeatUpload
Manual</h1>


<ul id="mozToc">
<!--mozToc h2 1 h3 2 h4 3 h5 4 h5 5 h6 6--><li><a href="#mozTocId469429">Release
Notes for NeatUpload-1.2.x</a>
    <ul>
      <li><a href="#mozTocId44439">Upgrading
from NeatUpload-1.1.x</a></li>
      <li><a href="#mozTocId432734">Upgrading
from NeatUpload-1.0.x</a></li>
      <li><a href="#mozTocId432817">New
Features in NeatUpload-1.2</a></li>
      <li><a href="#mozTocId953432">New
Features in NeatUpload-1.1</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId903858">Introduction</a></li>
  <li><a href="#Requirements">Requirements</a></li>
  <li><a href="#mozTocId304923">Installation</a></li>
  <li><a href="#mozTocId50790">Usage</a>
    <ul>
      <li><a href="#mozTocId879490">Using
NeatUpload with the Visual Studio Web Form Designer</a></li>
      <li><a href="#mozTocId170882">Using
NeatUpload without
the Visual Studio Web Form Designer</a></li>
      <li><a href="#mozTocId900479">Avoiding
Unnecessary Uploads and Progress Displays</a></li>
      <li><a href="#mozTocId483750">Uploading
from a Client Application</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId221000">Configuration</a>
    <ul>
      <li><a href="#mozTocId576312">Using
the &lt;neatUpload&gt;
Configuration Section</a></li>
      <li><a href="#mozTocId905959">Changing
the Temporary Directory Used by the FilesystemUploadStorageProvider</a></li>
      <li><a href="#mozTocId134915">Using
Location Filtering to Restrict/Modify NeatUpload's Request
Processing</a></li>
      <li><a href="#mozTocId970185">Limiting
the Size of Upload Requests</a></li>
      <li><a href="#mozTocId358727">Changing
the Maximum Size of Normal Requests</a></li>
      <li><a href="#mozTocId991184">Changing
the Query String Parameter Used When Uploading From Client Applications</a></li>
      <li><a href="#mozTocId652103">Configuring
Individual InputFile Controls Programmatically</a></li>
    </ul>
  </li>
  <li><a href="#SqlServerInputFile">The SqlServerInputFile Extension</a>
    <ul>
      <li><a href="#SqlServerInputFileInstall">Installation</a></li>
      <li><a href="#SqlServerInputFileConfigure">Configuration</a></li>
      <li><a href="#SqlServerInputFileUse">Usage</a></li>
      <li><a href="#SqlServerInputFileExample">Example</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId831551">The
HashedInputFile Extension</a></li>
  <li><a href="#mozTocId250326">Customization</a>
    <ul>
      <li><a href="#mozTocId628349">Customizing
Progress.aspx</a></li>
      <li><a href="#mozTocId184279">Creating
Custom Fallback Content for ProgressBar</a></li>
      <li><a href="#mozTocId759939">Creating
a Custom UploadStorageProvider</a></li>
      <li><a href="#mozTocId614710">Handling non-absolute paths in IE6</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId580088">Known
Issues</a>
    <ul>
      <li><a href="#IIS7">NeatUpload does not work in IIS7's default application pool</a></li>
      <li><a href="#AspNetTrace">ASP.NET application-wide tracing disables NeatUpload</a></li>
      <li><a href="#WebGardenIssue">ProgressBar doesn't work with web gardens/farms</a></li>
      <li><a href="#Permissions">Permissions on uploaded files depend on temporary directory</a></li>
      <li><a href="#UploadHttpModuleFirst">Module conflicts can cause data length is shorter than Content-Length errors</a></li>
      <li><a href="#ProgressBarViewState"><code>InvalidOperationException</code> when using <code>ProgressBar</code> 
      with <code>EnableViewState="false"</code></a></li>
      <li><a href="#mozTocId766780">HttpResponse.AppendToLog()
does nothing when UploadHttpModule is used</a></li>
      <li><a href="#HeaderEncoding">Setting HttpResponse.HeaderEncoding
does nothing when UploadHttpModule is used</a></li>
      <li><a href="#mozTocId752771">Inline
ProgressBars don't work with Opera</a></li>
      <li><a href="#mozTocId181845">Non-absolute path in IE7 causes the progress display to start even though no upload occurs</a></li>
      <li><a href="#OnClickReturnValue">Handler returning false does not block default action in IE6</a></li>
      <li><a href="#MacIELinkButtons"><code>LinkButtons</code> do not start the progress display in Internet Explorer 
for the Mac</a></li>
      <li><a href="#LargeResponseNotBuffered">Sometimes responses larger than 1MB are not buffered</a></li>
    </ul>
  </li>
  <li><a href="#mozTocId405545">Troubleshooting</a></li>
</ul>


<h2><a class="mozTocH2" name="mozTocId469429"></a>Release
Notes for NeatUpload-1.2.x</h2>


<h3><a class="mozTocH3" name="mozTocId44439"></a>Upgrading
from NeatUpload-1.1.x</h3>


NeatUpload-1.2.x is intended to be
completely&nbsp;backward-compatible with NeatUpload-1.1.x.<br>


<br>


To upgrade, simply
replace your
<code>Brettle.Web.NeatUpload.dll</code> with the copy from
NeatUpload-1.2.x and copy
<code>Progress.js</code><code></code> from <code>NeatUpload-1.2.x/NeatUpload/</code>
to the <code>NeatUpload/</code>
subfolder in your web application.&nbsp;
<h3><a class="mozTocH3" name="mozTocId432734"></a>Upgrading
from NeatUpload-1.0.x</h3>


NeatUpload-1.1.x is intended to be almost
completely&nbsp;backward-compatible with NeatUpload-1.0.x.
&nbsp;The
only exception is that <code>ProgressBar</code>s must now
be placed somewhere inside a <code>&lt;form&gt;</code>
element. &nbsp;In almost all cases that will already be the case so
this should not be a major issue. &nbsp;<br>


<br>


To upgrade, simply
replace your
<code>Brettle.Web.NeatUpload.dll</code> with the copy from
NeatUpload-1.1.x and add
<code>Progress.js</code> and <code>Error413.aspx</code>
from <code>NeatUpload-1.1.x/NeatUpload/</code>
to the <code>NeatUpload/</code>
subfolder in your web application.
&nbsp;If you have not customized your <code>Progress.aspx</code>
page, you
should replace it with <code>NeatUpload-1.1.x/NeatUpload/Progress.aspx</code>.
&nbsp;If you have customized it, consider changing it to use
the new <code>&lt;Upload:DetailsSpan&gt;</code>
and <code>&lt;Upload:DetailsDiv&gt;</code>
elements to take advantage of&nbsp;<a href="http://en.wikipedia.org/wiki/AJAX">AJAX</a>
refreshless updates<code></code>.&nbsp; See <a href="Manual.html#Customizing_Progress_aspx">Customizing
Progress.aspx</a> for details.<br>


<br>


If you
recompile, you will see some warnings about obsoleted/deprecated
methods. &nbsp;Those methods may be removed in NeatUpload-2.x.
&nbsp;You
are
encouraged to switch to their replacements, but that is not required
for NeatUpload-1.1.x.
&nbsp;Similarly, you are encouraged to use the new
custom
configuration section instead of the NeatUpload-1.0.x appSettings.
&nbsp;The old appSettings
still work in NeatUpload-1.1.x, but the new custom configuration
section provides much more flexibility, including the ability to use
location filtering to restrict the requests that NeatUpload touches.
&nbsp;See <a href="Manual.html#mozTocId221000">Configuration</a>
for details.<br>


<h3><a class="mozTocH3" name="mozTocId432817"></a>New
Features in NeatUpload-1.2</h3>


<ul>


  <li>Added support for <a href="Manual.html#mozTocId652103">Configuring
Individual InputFile Controls Programmatically</a>.</li>


  <li>Added support for <a href="Manual.html#mozTocId483750">Uploading
from a Client Application</a>.</li>


</ul>


<h3><a class="mozTocH3" name="mozTocId953432"></a>New
Features in NeatUpload-1.1</h3>


New features for end-users:
<ul>


  <li>Added more upload details to the default progress display,
including total upload size, amount and percent already uploaded, and
upload rate.</li>


  <li>Improved user experience when uploads are
too large. &nbsp;The progress bar now indicates that the upload was
rejected
and whenever practical the upload is stopped by the browser so that the
user remains on the original form.</li>


  <li>Added support for <a href="http://en.wikipedia.org/wiki/AJAX">AJAX</a>
refreshless updates of the progress bar.</li>


  <li>Prevented file upload and progress display when
client-side validation fails.</li>


  <li>Prevented file upload and progress
display when form submission is initiated by a non-trigger control.
&nbsp;At least one trigger control must be specified for this to
work.</li>


  <li>Added support for <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpgenref/html/cpconlinkbuttonwebcontrol.asp">LinkButtons</a>.</li>


</ul>


New features for developers:<br>


<ul>


  <li>Added support for <code>&lt;neatUpload&gt;</code>
configuration section which can be
placed either in the <code>&lt;brettle.web&gt;</code>
or the <code>&lt;system.web&gt;</code> section
group,
either of which can be put inside of the <code>&lt;location&gt;</code>
element to apply
configuration settings to specific
pages.</li>


  <li>Added support for custom <code>UploadStorageProvider</code>s.</li>


  <li>Added support for more flexible progress display
customization using new <code>&lt;Upload:DetailsSpan&gt;</code>
and <code>&lt;Upload:DetailsDiv&gt;</code>
elements.</li>


  <li>Added <code>Url</code> property to <code>ProgressBar</code>
control to specify location of progress display page (defaults to <code>NeatUpload/Progress.aspx</code>).</li>


  <li>Added Visual Studio designer support.</li>


  <li>Added support for accessing uploaded files from server
event handlers (e.g. <code>Button.Click</code> handlers).</li>


  <li>Added&nbsp;<code>Triggers</code> property
to <code>ProgressBar</code> which can be used instead of
the <code>ProgressBar.AddTrigger()</code> method.</li>


  <li>Changed the <code>InputFile.FileName</code>
property to always return just the
client-side file name (e.g. <code>foo.txt</code>), even if
the browser sends the
full path (e.g. <code>C:\dir\foo.txt</code>). &nbsp;
Since, Internet Explorer is the
only popular browser to send the full path, and the full path is
difficult to handle reliably on non-Windows servers which don't use
backslash ("\") as a path separator, returning the full path was likely
to result in code which is browser-specific and not portable.</li>


  <li>Removed dependency on <a href="http://logging.apache.org/log4net/">log4net</a>.
&nbsp;NeatUpload can still be built to use log4net if you want.
&nbsp;The dependency was removed to simplify installation/usage.</li>


  <li>Moved progress display Javascript to <code>Progress.js</code>
to reduce bandwidth required to download <code>Progress.aspx</code>
repeatedly.</li>


  <li>Removed <code>Demo.aspx.cs</code> from <code>Brettle.Web.NeatUpload.dll</code>.
&nbsp;It is now compiled on the fly when <code>Demo.aspx</code>
is requested.</li>


</ul>


<h2><a class="mozTocH2" name="mozTocId903858"></a>Introduction</h2>


<p> <a href="http://www.brettle.com/neatupload">NeatUpload</a>
allows <a href="http://en.wikipedia.org/wiki/ASP.NET">ASP.NET</a>
developers to stream uploaded files to disk and allows users to monitor
upload progress. It is <a href="http://opensource.org/docs/definition.php">open source</a>
and works under <a href="http://www.mono-project.com/">Mono's</a>
<a href="http://www.go-mono.com/asp-net.html#xsp">XSP</a>
/ <a href="http://www.go-mono.com/asp-net.html#mod_mono">mod_mono</a>
as well as Microsoft's ASP.NET implementation. </p>


<p> NeatUpload contains four custom controls (<code>InputFile</code>,
<code>ProgressBar</code>, <code>DetailsSpan</code>,
and <code>DetailsDiv</code>), an <code>HttpModule</code>
(<code>UploadHttpModule</code>), and a Page subclass (<code>ProgressPage</code>).
This section briefly describes what they each do and how they are
related. The remainder of this manual describes how to install and use
NeatUpload. </p>


<p> <code><strong>InputFile</strong></code>
is a custom control that renders like <code>HtmlInputFile</code>,
but provides properties to access the
uploaded file's client-specified name, content, and MIME type, and a
method to
move the file to a permanent location. </p>


<p> <code><strong>ProgressBar</strong></code>
is a custom control that is responsible for providing a site for the
progress to be displayed. It provides an attribute to control whether
to display the progress inline or in a popup. It also provides ways to
control which buttons cause the progress
display to start refreshing. If the progress is displayed inline, the <code>ProgressBar</code>
control renders as an <code>IFRAME</code>. Otherwise, it
renders as a <code>DIV</code> containing
a "Check Upload Progress" link (to display the progress in a new
window) along with some JavaScript which removes the <code>DIV</code>
when the page
loads. This provides a fallback when JavaScript is not available. Note
that <code>ProgressBar</code> doesn't actually display the
progress bar itself. It merely provides a site (an <code>IFRAME</code>
or popup)
which loads a page derived from <code>ProgressPage</code>
(by default <code>Progress.aspx</code>). &nbsp;The <code>ProgressPage</code>
subclass displays the progress bar. </p>


<p> <code><strong>UploadHttpModule</strong></code>
is an <code>HttpModule</code> that intercepts HTTP
requests, streams <code>InputFile</code> uploads to
temporary files, and restricts the size of the remainder of the
request. By default, <code>UploadHttpModule</code>
intercepts every
request. &nbsp;As a result, a bug in NeatUpload could affect pages
that don't even contain <code>InputFile</code>
controls. For this reason, you can configure NeatUpload to only use <code>UploadHttpModule</code>
for certain pages (or even none) while continuing to use <code>InputFile</code>
and <code>ProgressBar</code>. When <code>UploadHttpModule</code>
is not used for a request, NeatUpload gets the uploaded file from the
ASP.NET standard <code>HttpRequest.Files</code>
property instead of intercepting the request. That means that <code>InputFile</code>
will function like an <code>HtmlInputFile</code> control,
but no progress bar will be displayed. This greatly reduces the risk of
adopting NeatUpload. </p>


<p> <code><strong>ProgressPage</strong></code>
is a subclass of&nbsp;<code>System.Web.UI.Page</code>
that is used as the base class for pages displayed in the site provided
by the <code>ProgressBar</code>
control (i.e. in the <code>IFRAME</code> or popup). <code>&nbsp;Progress.aspx</code>
is the default <code>ProgressPage</code>. &nbsp;<code>ProgressPage
</code>retrieves
the details of the upload process from the <code>UploadHttpModule</code>.
and makes them available for subclasses to use in data-binding
expressions.&nbsp; <code>ProgressPage</code>
subclasses (e.g. <code>Progress.aspx</code>) place such
data-binding expressions within <code style="font-weight: bold;">DetailsSpan</code><span style="font-weight: bold;"> </span>and <code style="font-weight: bold;">DetailsDiv</code><span style="font-weight: bold;"> </span>controls so that
NeatUpload can use AJAX techniques to update the values without
requiring a browser a refresh. </p>


<h2><a class="mozTocH2" name="Requirements"></a>Requirements</h2>

<p>To use NeatUpload you will need:
	<ul>
		<li>.NET Framework 1.1, .NET Framework 2.0, or Mono 1.1.  Mono users that are using the mod_mono Apache
		module should use mod_mono 1.1.14 or later.</li>
		<li>A workign web application with "Full" <a href="http://msdn2.microsoft.com/en-us/library/tkscy493.aspx">trust</a>.  
			That trust level is the default, but some hosting providers	force web applications to run with reduced trust.</li>
	</ul>
</p>

<h2><a class="mozTocH2" name="mozTocId304923"></a>Installation</h2>


<p> Installing NeatUpload is pretty straightforward. Just copy
the necessary assemblies and subdirectories into your application and
make some
modifications to your <code>Web.config</code>.
&nbsp;Specifically: </p>


<ol>


  <li>If you haven't already, download the release and extract
it wherever you want. All the files will be extracted into a
subdirectory named <code>NeatUpload-1.1.<span style="font-style: italic;">x</span>/</code>. </li>


  <li>(Optional) To see the demo running on your local machine,
configure IIS, mod_mono, or XSP so that <code>NeatUpload-1.1.<span style="font-style: italic;">x</span>/</code>
is a web application. Then point your browser at the <code>Demo.aspx</code>
on that
website. To use NeatUpload in your own web application, continue with
the remaining installation steps. </li>


  <li>If you will be using the Visual Studio Web Form Designer,
add the NeatUpload controls to your toolbox. &nbsp;To do that,
right-click
on the Toolbox, click Add/Remove Items, Browse to&nbsp;&nbsp;<code>NeatUpload-1.1.x/bin/Brettle.Web.NeatUpload.dll</code>,
click Open, and then click
OK. &nbsp;A reference to <code>Brettle.Web.NeatUpload.dll</code>
will
automatically be added to your project the first time you use the
designer to add one of the NeatUpload controls to a form.</li>


  <li>If you won't be using the Visual Studio Web Form Designer,
add a reference to your web application that refers to the <code>Brettle.Web.NeatUpload.dll</code>
in the <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/bin
    </code>directory. </li>


  <li>Create a <code>NeatUpload/</code>
subdirectory in
your web application by copying<span style="font-style: italic;"></span>
    <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/NeatUpload/</code>
and its contents. &nbsp;Don't copy the whole <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/
    </code>directory, just the <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/NeatUpload/
    </code>subdirectory. &nbsp;That subdirectory contains <code>Progress.aspx</code>
and associated files. </li>


  <li>Add the following line to your <code>Web.config</code>
under <code>configuration/system.web/httpModules</code>:
    
    <pre>&lt;add name="UploadHttpModule" type="Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload" /&gt;<br>	</pre>


  </li>


  <li>(Optional) To allow larger uploads than the default of 4
Mbytes under Microsoft's ASP.NET, &nbsp;you <span style="font-style: italic;">might</span> need to add
or modify the following element
in your <code>Web.config</code>
under <code>configuration/system.web</code>:
    
    <pre>&lt;httpRuntime maxRequestLength="<var>size_in_kbytes</var>" /&gt;<br></pre>


At the moment, both .NET and Mono seem to ignore that setting when
NeatUpload is being used, but there is no official documentation
specifying exactly when that limit is enforced, so a future version of
.NET or Mono might enforce the limit even when NeatUpload is being
used. &nbsp; Setting the <code>&lt;httpRuntime&gt;</code>
element's <code>maxRequestLength</code>
attribute simply provides insurance against such future changes.
&nbsp;Note
that since that attribute is currently ignored when NeatUpload is used,
you can't use it to actually restrict the size of uploads. &nbsp;To
do that,
see <a href="#Limiting_the_Size_of_Upload_Requests">Limiting
the Size of Upload Requests</a> below.<br>


  </li>


  <li>(Optional) Copy <code>Demo.aspx</code> and <code>Demo.aspx.cs</code>
from <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/</code>
into your application. Point your browser at <code>Demo.aspx</code>
and verify that the demo functions properly. </li>


</ol>


<ol>


</ol>


<h2><a class="mozTocH2" name="mozTocId50790"></a>Usage</h2>


<span style="font-style: italic;">
The following instructions should work with Visual Studio 2003 and
Visual Studio 2005. &nbsp;If you are using Visual Studio 2002, you
will
need to convert the NeatUpload projects/solution to the Visual Studio
2002 format, make some code changes, and rebuild the NeatUpload
solution. &nbsp;There is a <a href="http://www.brettle.com/ForumThreadView.aspx?thread=84&amp;pageindex=7">forum
thread</a> discussing the process in more detail.</span><span style="font-style: italic;"></span>
<h3><a class="mozTocH3" name="mozTocId879490"></a>Using
NeatUpload with the Visual Studio Web Form Designer</h3>


<p>To use the Visual Studio web form designer to add NeatUpload
to a web form, follow these steps: </p>


<ol>


  <li>Drag the following controls from the toolbox onto your web
form:&nbsp;<code>InputFile</code>, <code>ProgressBar</code>,
and <code>Button</code>.</li>


  <li>(Optional) If you want an inline progress bar, set the <code>ProgressBar</code>'s
    <code>Inline</code> property to <code>true</code>.
  </li>


  <li>(Optional) If you want to customize the <code>ProgressBar</code>
fallback behavior, drag whatever control(s) you want displayed as a
fallback onto the <code>ProgressBar</code> control.
&nbsp;For example, to just change the fallback text, you could drag
a <code>Label</code> control onto the ProgressBar and edit
its contents.</li>


  <li>In your codebehind file,&nbsp;process the
uploaded
file. &nbsp;The uploaded file's client-specified
name, MIME type, and contents can be accessed via <code><var>inputFileId</var>.FileName</code>,
    <code><var>inputFileId</var>.ContentType</code>,
and <code><span style="font-style: italic;">inputFileId</span>.FileContent</code>,
respectively.
&nbsp;<span style="font-weight: bold;">If you want to
keep the uploaded file, you must use the </span><code style="font-weight: bold;"><span style="font-style: italic;">inputFileId</span>.MoveTo()</code><span style="font-weight: bold;">method
to
move the uploaded file to a permanent location. &nbsp;If you do
not,
NeatUpload will automatically remove the uploaded file at the end of
the request</span> to ensure that unwanted files are not left on
the filesystem. &nbsp;The following code will put the uploaded file
in the
application's root directory (assuming
sufficient permissions):
    
    <pre>using Brettle.Web.NeatUpload;<br>...<br>using System.IO;<br>...<br>public class YourPage : System.Web.UI.Page<br>{<br>	private void Page_Load(object sender, EventArgs e)<br>	{<br>	...<span style="font-style: italic;"><br>	submitButtonId.Click</span> += new System.EventHandler(this.Button_Clicked);<br>	...<br>	}<br>	...<br>	private void Button_Clicked(object sender, EventArgs e)<br>	{<br>	...<br>	if (IsValid &amp;&amp; <var>inputFileId</var>.HasFile)<br>	{<br>	...<br>	<var>	inputFileId</var>.MoveTo(Path.Combine(Request.PhysicalApplicationPath,&nbsp;<var>inputFileId</var>.FileName),&nbsp;<br>	MoveToOptions.Overwrite);</pre>


  </li>


</ol>


<h3><a class="mozTocH3" name="mozTocId170882"></a>Using
NeatUpload <span style="font-style: italic;">without</span>
the Visual Studio Web Form Designer</h3>


<p> To use NeatUpload on a web form <span style="font-style: italic;">without</span> using the
Visual Studio designer, follow these steps: </p>


<ol>


  <li>Add the following to the top of your page:
    
    <pre> <br>&lt;%@ Register TagPrefix="Upload" Namespace="Brettle.Web.NeatUpload" Assembly="Brettle.Web.NeatUpload" %&gt;<br>	</pre>


  </li>


  <li>Add an <code>InputFile</code> control to your
aspx page wherever you
want the user to choose a file, using something like this:
    
    <pre>&lt;Upload:InputFile id="<var>inputFileId</var>" runat="server" /&gt;<br>	</pre>


Feel free to add any attributes that you would normally add to an <code>HtmlInputFile</code>
tag. </li>


  <li>Add a <code>ProgressBar</code> control to
your aspx page wherever you
want to display an inline progress bar or, in the case of a popup
progress bar, add it wherever you want the fallback link to be
displayed. &nbsp;Use something like this:
    
    <pre>&lt;Upload:ProgressBar id="<var>progressBarId</var>" runat="server" inline="<var>true|false</var>" /&gt;<br>	</pre>


The inline attribute defaults to false. </li>


  <li>Add a submit button to your aspx page. For example:
    
    <pre>&lt;asp:Button id="<var>submitButtonId</var>" runat="server" Text="<var>Submit</var>" /&gt;<br></pre>


    <span style="font-weight: bold;"></span></li>


  <li><span style="font-weight: bold;"></span>In
your codebehind file, declare each <code>InputFile</code>,
    <code>ProgressBar</code>, and <code>Button</code>
control using code like this:
    
    <pre>using Brettle.Web.NeatUpload;<br>...<br>using System.Web.UI.WebControls;<br>...<br>public class YourPage : System.Web.UI.Page<br>{<br>	...<br>	protected InputFile <var>inputFileId</var>;<br>	protected ProgressBar <var>progressBarId</var>; <br>	protected Button <span style="font-style: italic;">submitButtonId</span>;</pre>


  </li>


  <li>In your codebehind file,&nbsp;process the
uploaded
file. &nbsp;The uploaded file's client-specified
name, MIME type, and contents can be accessed via <code><var>inputFileId</var>.FileName</code>,
    <code><var>inputFileId</var>.ContentType</code>,
and <code><span style="font-style: italic;">inputFileId</span>.FileContent</code>,
respectively.<code></code>
&nbsp;<span style="font-weight: bold;">If you want to
keep the uploaded file, you must use the </span><code style="font-weight: bold;"><span style="font-style: italic;">inputFileId</span>.MoveTo()</code><span style="font-weight: bold;">method
to
move the uploaded file to a permanent location. &nbsp;If you do
not,
NeatUpload will automatically remove the uploaded file at the end of
the request</span> to ensure that unwanted files do not fill up
the filesystem. &nbsp;The following code will put the uploaded file
in the
application's root directory (assuming
sufficient permissions):
    
    <pre>using Brettle.Web.NeatUpload;<br>...<br>using System.IO;<br>...<br>public class YourPage : System.Web.UI.Page<br>{<br>	private void Page_Load(object sender, EventArgs e)<br>	{<br>	...<br style="font-style: italic;"><span style="font-style: italic;"> submitButtonId.Click</span> += new System.EventHandler(this.Button_Clicked);<br>	...<br>	}<br>	...<br>	private void Button_Clicked(object sender, EventArgs e)<br>	{<br>	...<br>	if (IsValid &amp;&amp; <var>inputFileId</var>.HasFile)<br>	{<br>	...<br>	<var>	inputFileId</var>.MoveTo(Path.Combine(Request.PhysicalApplicationPath,&nbsp;<var>inputFileId</var>.FileName),&nbsp;<br>	MoveToOptions.Overwrite);<br></pre>


  </li>


</ol>


<h3><a class="mozTocH3" name="mozTocId900479"></a>Avoiding
Unnecessary Uploads and Progress Displays</h3>


By default, anytime the user submits a form containing a non-empty <code>InputFile</code>
and a <code>ProgressBar</code>, the progress display is
started (either inline or in a popup). &nbsp;If all <code>InputFiles</code>
are empty, the progress display is not started. &nbsp;That ensures
that
the user is not distracted by a transient and meaningless progress
display.<br>


<br>


Now consider the case where the form contains a cancel button in
addition to a normal submit button. &nbsp;Both buttons cause the
form
to be submitted, but when the cancel button is clicked, the server
ignores the values on the form. &nbsp;By default, if the user
selects a
file to upload and then changes his mind and clicks the cancel button,
the progress display will start and the user will need to wait for the
file to be uploaded. &nbsp;To avoid this unfriendly behavior,
NeatUpload allows you to specify "trigger" controls. &nbsp;If you
specify at least one trigger, then form submissions&nbsp;initiated
via
any <span style="font-style: italic;">other</span>
control will cause NeatUpload to clears all the <code>InputFile</code>
controls
so that no files will be uploaded and the progress display will not
start. &nbsp;(On some downlevel browsers, notably Internet Explorer
for
the Mac, NeatUpload can't clear the controls so it displays a dialog
asking the user to clear them manually and try again. &nbsp;The
text
for that dialog can be customized via the <code>ClearFileNamesAlert</code>
resource in <code>Strings.resx</code>.)<br>

<br>

If your form contains more than one <code>ProgressBar</code>, each
<code>ProgressBar</code> which specifies trigger controls will only start when
the form submission is initiated by one of those controls.<br>

<br>


There are two ways to indicate that a control is a "trigger" control.
&nbsp;You can either include the ID of the control in the <code>ProgressBar</code>'s
<code>Triggers </code>property (multiple IDs
should be space-separated),&nbsp;or you can call the ProgressBar's <span style="font-family: monospace;">AddTrigger</span><code>(Control)</code>
method. &nbsp;Note: if you call the <code>AddTrigger(Control)</code>
method, you need to call it each time the page is loaded (even when <code>Page.IsPostBack</code>
is <code>true</code>) because the list of trigger controls
is not maintained in the page's <code>ViewState</code>.<br>


<br>


<h3><a class="mozTocH3" name="mozTocId483750"></a>Uploading
from a Client Application</h3>


If your users are uploading using their web browser, you don't need to
read this section. &nbsp;This section is for environments where a
separate client application uses HTTP POST requests to uploads files to
a form containing an <code>InputFile</code> control.
&nbsp;You should read the earlier sections before reading this one.<br>


<br>


In order for NeatUpload to process requests from non-browser client
applications, the query string of each request needs to contain a
unique ID&nbsp;called a post-back ID. &nbsp;NeatUpload looks
for the
post-back ID in a query string parameter. &nbsp;The parameter name
is <a href="#mozTocId991184">configurable</a>.
&nbsp;By default, NeatUpload looks for a parameter named
"NeatUpload_PostBackID". &nbsp;The post-back ID itself does not
need to
be in any particular format, but it needs to be unique for each
request. &nbsp;So, for example, if the client application uploads
the
file to :<br>


<br>


<div style="margin-left: 40px;"><code>http://www.tempuri.org/path/to/MyUploadPage.aspx?NeatUpload_PostBackID=afa02a6999e54541bb6873151d1dfbfc</code><br>


</div>


<br>


then NeatUpload will use "afa02a6999e54541bb6873151d1dfbfc" as the
post-back ID.<br>


<br>


If NeatUpload finds the post-back ID in the query string it will assume
that all files in the request are destined for <code>InputFile</code>
controls and will stream them all to storage. &nbsp;To ensure that
you
can access the uploaded files from your page, make sure that the name
of the form field(s) used by the client application match the control
IDs of your <code>InputFile</code> control(s).
&nbsp;So, if your client application uses a field name of
"FILE001", you should use put the following in your page:<br>


<br>


<div style="margin-left: 40px;"><code>...<br>


&lt;Upload:InputFile id="FILE001" runat="server" /&gt;<br>


...<br>


</code></div>


<br>


<h2><a class="mozTocH2" name="mozTocId221000"></a>Configuration</h2>


<h3><a class="mozTocH3" name="mozTocId576312"></a>Using
the <code>&lt;neatUpload&gt;</code>
Configuration Section</h3>


To configure NeatUpload, you need to add the NeatUpload configuration
section handler to your <code>Web.config</code>:<br>


<br>


<code>&lt;configuration&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;configSections&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;sectionGroup name="system.web"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;section name="neatUpload"
type="Brettle.Web.NeatUpload.ConfigSectionHandler,
Brettle.Web.NeatUpload" allowLocation="true" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/sectionGroup&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;/configSections&gt;<br>


...</code><br>


<br>


Note: The <code>sectionGroup</code> "name" attribute can
be either "system.web" or "brettle.web". &nbsp;Although using
"brettle.web" is better for preventing name collisions, it makes it
impossible to do location filtering under Mono (at least as of
1.1.9.2). &nbsp;Even under .NET, you will have to do more typing to
configure location filtering if you use "brettle.web" than if you use
"system.web". &nbsp;The remainder of this document assumes you are
using "system.web".<br>


<br>


Once you've added the configuration section handler, you can add the
&lt;neatUpload&gt; element inside your <code>Web.config</code>'s
&lt;system.web&gt; element(s), like this:<br>


<code><br>


&lt;configuration&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;neatUpload <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; useHttpModule="<span style="font-style: italic;">true or false, defaults to true</span>"<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; maxNormalRequestLength="</code><code style="font-style: italic;">up to 2097151</code><code><span style="font-style: italic;"> in KBytes, defaults to 4096</span>"
<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; maxRequestLength="</code><code style="font-style: italic;">up to 2097151</code><code style="font-style: italic;"> in KBytes</code><code><span style="font-style: italic;">, defaults to </span></code><code style="font-style: italic;">2097151</code><code style="font-style: italic;"></code><code><span style="font-style: italic;"></span>" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; postBackIDQueryParam="<span style="font-style: italic;">parameter name, defaults to
NeatUpload_PostBackID</span>"<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;defaultProvider="<span style="font-style: italic;">friendly name, defaults to a
FilesystemUploadStorageProvider using the system temp dir</span>"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&lt;providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;add name="<span style="font-style: italic;">friendly
name</span>" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp; type="<span style="font-style: italic;">type derived from
Brettle.Web.NeatUpload.UploadStorageProvider</span>" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp; <span style="font-style: italic;">provider-specific-<span style="font-family: monospace;">attributes</span></span>
... /&gt;<br>


</code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&lt;remove name="<span style="font-style: italic;">friendly name of provider</span>"
/&gt;<br>


</code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&lt;clear /&gt;<br>


</code><code></code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;/providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/neatUpload&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&lt;/configuration&gt;<br>


</code><br>


The <code>&lt;providers&gt;</code> element is
optional. &nbsp;You only need to use it if you are using an <code>UploadStorageProvider</code>
other than the default <code>FilesystemUploadStorageProvider</code>,
or you need to change the temporary directory used by the <code>FilesystemUploadStorageProvider</code>.
&nbsp;In those cases, you should include an &lt;add&gt;
element for
each provider or provider configuration you will be using and set the
&lt;neatUpload&gt; element's&nbsp;<code>defaultProvider</code>
attribute to the name you chose for the provider you want to use by
default. &nbsp;For specific pages or directories, you can override
that
default or add/remove/clear available providers using child
configuration sections. &nbsp;Child configuration sections are
&lt;neatUpload&gt; elements within &lt;location&gt;
elements or in
Web.config files in subdirectories.<br>


<br>


Note that each provider object is created and initialized at most once
during the application lifecycle - when the configuration section
containing the associated &lt;add&gt; element is relevant to a
request.
&nbsp;A configuration section is relevant to a request if the
request
matches the "path" attribute of the containing &lt;location&gt;
element. &nbsp;If there is no containing &lt;location&gt;
element, the
configuration section is relevant if the requested page is in the
directory hierarchy controlled by the containing Web.config.
&nbsp;This means that multiple provider objects might be created
and initialized in
response to a request, but only the one configured as the
"defaultProvider" for the requested page is actually used for that
request. &nbsp;The others might be configured as&nbsp;default
providers
for other pages.
<h3><a class="mozTocH3" name="mozTocId905959"></a>Changing
the Temporary Directory Used by the FilesystemUploadStorageProvider</h3>


<p> By default, NeatUpload puts uploaded files in temporary files
in the <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemiopathclassgettemppathtopic.asp">system's
temporary directory</a>. You can specify a different directory
using the <code>tempDirectory</code> attribute of the <code>FilesystemUploadStorageProvider</code>,
like this:
</p>


<pre>	&lt;neatUpload ...<code> defaultProvider="FilesystemUploadStorageProvider" ...</code>&gt;<br><code>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&lt;providers&gt;<br>	...<br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&lt;add name="<span style="font-style: italic;"></span></code><code>FilesystemUploadStorageProvider</code><code><span style="font-style: italic;"></span>" <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; type="Brettle.Web.NeatUpload.</code><code>FilesystemUploadStorageProvider</code><code><span style="font-style: italic;"></span>" <br>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; t</code><code>empDirectory="<span style="font-style: italic;">path, defaults to path returned by System.IO.Path.GetTempPath()</span>"</code><code><span style="font-style: italic;"></span> ... /&gt;<br>	...<br></code><code></code><code>&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&lt;/providers&gt;</code><code><br></code>	&lt;/neatUpload&gt;<br>	</pre>


If you specify a relative path, it will be relative to your
application root directory.
<h3><a class="mozTocH3" name="mozTocId134915"></a>Using
Location Filtering to Restrict/Modify NeatUpload's Request
Processing</h3>


By default, whenever NeatUpload's <code>UploadHttpModule</code>
is added via the <code>&lt;httpModules&gt;</code>
section of your <code>Web.config</code>, it intercepts and
filters <span style="font-style: italic;">all</span><span style="font-weight: bold; font-style: italic;"> </span>requests
sent to your application. &nbsp;For upload requests, it streams the
uploaded files to disk and makes them available to your code via <code>InputFile</code>.
&nbsp;It also limits the size of the non-upload part of the request
<span style="font-style: italic;">and the total size of
non-upload requests</span>
because that request data is stored in server memory. &nbsp;If it
didn't do that an attacker could mount a Denial of Service attack by
sending a request that contains up to <code>maxRequestLength</code>
kilobytes of non-file data.<br>


<br>


You can disable use of <code>UploadHttpModule</code> by
settting the <code>&lt;neatUpload&gt;</code>
element's <code>useHttpModule</code> attribute to
false. &nbsp;If you want to use the <code>UploadHttpModule</code>
for only some
requests, you can use ASP.NET's <code>&lt;location&gt;</code>
element to
specify which pages it should be used for. &nbsp;You can also use
the <code>&lt;location&gt;</code> element to
control which <code>UploadStorageProvider</code> is used
for specific pages. &nbsp;For example,
consider the following configuration:<br>


<br>


<code>&lt;configuration&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;httpRuntime maxRequestLength="100" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;httpModules&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;add name="UploadHttpModule"
type="Brettle.Web.NeatUpload.UploadHttpModule, Brettle.Web.NeatUpload"
/&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &lt;/httpModules&gt;<br>

&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;neatUpload useHttpModule="false" maxNormalRequestLength="100"
maxRequestLength="2097151"&gt;<br>


</code><code>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;providers&gt;<br>


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;add name="special"
type="Brettle.Web.NeatUpload.FilesystemUploadStorageProvider" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
tempDirectory="SpecialTempDirectory"
/&gt;<br>


&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&lt;/providers&gt;<br>


</code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&lt;/neatUpload&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;location path="Demo.aspx"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;neatUpload useHttpModule="true"
/&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;httpRuntime
maxRequestLength="2097151" executionTimeout="3600" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;/location&gt;<br>


</code><code>
&nbsp;&nbsp;&nbsp; &lt;location
path="Special.aspx"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;neatUpload useHttpModule="true"
defaultProvider="special" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;httpRuntime
maxRequestLength="2097151" executionTimeout="3600" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;/location&gt;<br>


</code><code>
&nbsp;&nbsp;&nbsp; ...<br>


&lt;/configuration&gt;<br>


<br>


</code>That configuration will cause the <code>UploadHttpModule</code>
to&nbsp;only be used for requests to <code>Demo.aspx</code>
and <code>Special.aspx</code>.
&nbsp;In addition, ASP.NET's <code>maxRequestLength</code>
is set to only 100 KBytes for all requests other than those two pages.
&nbsp;For those two pages<code></code>, the <code>maxRequestLength</code>
is increased to 2 GBytes and the <code>executionTimeout</code>
is increased to 1 hour. &nbsp;Also, requests for <code>Special.aspx</code>
use the "special" provider which is configured to use the
"<code>SpecialTempDirectory</code>", while requests for <code>Demo.aspx</code>
use the default provider which uses the system temporary directory.<br>

<br>

Note that you still need to add the <code>UploadHttpModule</code> in the <code>&lt;httpModules&gt;</code> section so that it will be available to your application.&nbsp; Location filtering
just gives you finer control over which requests the <code>UploadHttpModule</code>
actually touches.<br>


<br>


<h3><a class="mozTocH3" name="mozTocId970185"></a><a class="mozTocH3" name="Limiting_the_Size_of_Upload_Requests"></a>Limiting
the Size of Upload Requests</h3>


<p>By default, NeatUpload does not directly limit the size of
uploads.
&nbsp;To limit upload size,&nbsp;use the <code>&lt;neatUpload&gt;</code>
element's <code>maxRequestLength </code>attribute<code></code><code></code>:
</p>


<pre>	&lt;neatUpload ... maxRequestLength="<em>sizeInKBytes</em>" ... /&gt;<br></pre>


<p>If a user attempts to upload a file larger than the specified
size, NeatUpload will update the progress bar to indicate that the
upload was rejected because it was too large. &nbsp;If the progress
bar is in a pop-up window, it will leave the window
open to ensure that the user sees why the
upload was rejected. &nbsp; Next it will attempt to stop the upload
by asking the browser to run JavaScript that simulates clicking the
browser's Stop button. &nbsp;If JavaScript is enabled, most modern
browsers (including recent versions of IE, Firefox, and Opera) will be
able to stop the upload and the user will simply see the original form
along with the progress bar displaying the reason the upload was
rejected. &nbsp;The remainder of this section only affects the user
when the browser is <span style="font-style: italic;">not</span>
able to stop the upload.</p>


<p>After asking the browser to stop the upload using JavaScript,
NeatUpload reads the remainder of the request and then throws
an <code>UploadTooLargeException</code> . &nbsp;The <code>UploadTooLargeException&nbsp;</code>class
is a subclass of <code>UploadException</code> (which is a
subclass of <code>HttpException</code>) with an HTTP
status code of 413. &nbsp;If the browser hasn't stopped the upload
for some reason, the exception will cause the user to see&nbsp;a
generic error
page by default. &nbsp;If you want something
more
user-friendly, you can either handle the error by adding a handler for
the <code>HttpApplication.Error</code> event, or you can
use a custom
error page. &nbsp;NeatUpload comes with an example custom error
page. &nbsp;To
use it, add the following to your&nbsp;<code>Web.config</code>
under
<code>configuration/system.web</code>: </p>


<pre>	&lt;customErrors mode="On"&gt;<br>	&lt;error statusCode="413" redirect="~/NeatUpload/Error413.aspx" /&gt;<br>	&lt;/customErrors&gt;<br></pre>


<p>Note:
most browsers, including IE and Firefox, won't display any new content
until
the entire upload has been sent to the server. &nbsp;If that takes
longer
than the amount of time specified via the <code>httpRuntime</code>
element's <code>executionTimeout</code>
attribute, the server may choose to close the connection and the user
will see a different error. &nbsp;IE will display a generic error
page
saying "Page cannot be displayed". &nbsp;Firefox will display a
dialog
saying "Document contains no data". &nbsp;The default <code>executionTimeout</code>
is 360 seconds.</p>


<h3><a class="mozTocH3" name="mozTocId358727"></a>Changing
the Maximum Size of Normal Requests</h3>


<p>By default, NeatUpload
restricts the size of
non-upload requests and the non-upload portion of upload requests to 4
MBytes. To specify a different maximum
size,&nbsp;use the <code>&lt;neatUpload&gt;</code>
element's <code>maxNormalRequestLength </code>attribute<code></code>:
</p>


<pre>	&lt;neatUpload ... maxNormalRequestLength="<em>sizeInKBytes</em>" ... /&gt;<br></pre>


The behavior when this value is exceeded is similar to the behavior
when the <code>maxRequestLength</code>
is exceeded. &nbsp;See the preceding section for details.
&nbsp;The
only difference is that for non-upload requests that exceed the <code>maxNormalRequestLength</code>
limit, NeatUpload does not attempt to use JavaScript to interrupt the
browser and the exception that is thrown is an <code>HttpException(413,
"Request Entity Too Large")</code> instead of an <code>UploadTooLargeException()</code>.<br>


<h3><a class="mozTocH3" name="mozTocId991184"></a>Changing
the Query String Parameter Used When Uploading From Client Applications</h3>


If you are <a href="#mozTocId483750">uploading from a
client application</a>&nbsp;other
than a browser, you might not have control over the name of the query
string parameter that the application uses to identify each upload.
&nbsp;To configure NeatUpload to look for a query string parameter
with
a particular name, the <code>&lt;neatUpload&gt;</code>
element's <code>postBackIDQueryParam</code> attribute:<br>


<pre>	&lt;neatUpload ... postBackIDQueryParam="<em><span style="font-family: monospace;">parameterName</span></em>" ... /&gt;<br></pre>


The default value is "NeatUpload_PostBackID".<br>


<h3><a class="mozTocH3" name="mozTocId652103"></a>Configuring
Individual InputFile Controls Programmatically</h3>


You can use the <code>StorageConfig</code> property of
each <code>InputFile</code> control to change the way the <code>UploadStorageProvider</code>
handles the file uploaded to that control. &nbsp;The interpretation
of&nbsp;<code>InputFile.StorageConfig</code> depends on
which <code>UploadStorageProvider</code> is used.
&nbsp;The default <code>FilesystemUploadStorageProvider</code>
only allows the temporary directory to be set via the <code>StorageConfig</code>
property. &nbsp;To programmatically set the temporary directory
place a line like this in&nbsp;<code>Page_Load()</code>:<br>


<br>


<code><span style="font-style: italic;">inputFileId</span>.StorageConfig["tempDirectory"]
= "<span style="font-style: italic;">path_to_temp_directory</span>";</code><br>


<br>


Before using the <code>StorageConfig</code> property, it
is critical to understand how the <code>StorageConfig</code>
is communicated to the UploadStorageProvider to avoid some possible
pitfalls. &nbsp;When the <code>InputFile</code>
control is rendered, NeatUpload encrypts the <code>StorageConfig</code>
with an encryption key, signs it with a validation key and then renders
the ciphertext and signature in a hidden form field. &nbsp;When
NeatUpload receives the upload request, it retrieves the form field
value, verifies the signature, and decrypts the ciphertext to get the <code>StorageConfig</code>.
&nbsp;By default, NeatUpload automatically generates random
encryption
and validation keys when they are first needed during the application
lifetime. &nbsp;However, you can set them explicitly by setting the
<code>encryptionKey</code> and <code>validationKey</code>
attributes of the <code>&lt;neatUpload&gt;</code>
element to random 32 and 40 digit hexadecimal strings, respectively.<br>


<br>


Encrypting and signing the <code>StorageConfig</code>
prevents an attacker from examining and modifying it.
&nbsp;However, <span style="font-weight: bold;">it
does not prevent replay attacks and it will cause uploads to be
rejected if the server uses different keys for validation/decryption
than it did for signing/encryption</span>. &nbsp;Follow the
following rules to avoid these problems:<br>


<ul>


  <li>Only use <code>StorageConfig</code> to
configure an <code>InputFile</code> control if you don't
mind&nbsp;an attacker associating that <code>StorageConfig</code>
with other <code>InputFile</code> controls&nbsp;while
the same validation key is being used. &nbsp;This is not typically
a problem for <code>StorageConfig["tempDirectory"]</code>
because it is mostly used to specify a temporary directory on the same
drive as the final location of the file to improve performance.
&nbsp;If an attacker used a&nbsp; <code>StorageConfig</code>
from a
different control, they would typically just get poor performance.
&nbsp;Note, however, that if you decide to stop using a temporary
directory, you should either change the validation key or use some
other mechanism (e.g. change the permissions on the directory) to
ensure that an upload that uses an old <code>StorageConfig</code>
can not write to the old directory.</li>


  <li>Only use <code>StorageConfig</code> to
configure an <code>InputFile</code>
control if you don't mind having uploads rejected while transitioning
from old to new keys. &nbsp;NeatUpload will reject any uploads from
forms rendered with the old key. &nbsp;The default rejection
message is
the value of the <code>InvalidStorageConfigMessageFormat</code>
resource in <code>Strings.resx</code>. &nbsp;It
defaults to "Please refresh the page and try again."</li>


  <li>Don't use <code>StorageConfig</code> in an
environment (e.g. a
web farm) where the server rendering the form could be different from
the server that receives the upload request, unless you manually
configure all servers to use the same keys.</li>


</ul>

<h2><a class="mozTocH2" name="SqlServerInputFile"></a>The
SqlServerInputFile Extension</h2>

<p>
SqlServerInputFile is a NeatUpload extension generously contributed by 
Joakim Wennergren (jokedst at gmail dot com).  It streams uploaded files
to and from an SQL Server database and consists of the <code>SqlServerInputFile</code>
web control&nbsp;and a custom <code>UploadStorageProvider</code>
called <code>SqlServerUploadStorageProvider</code>.
</p>

<h3><a class="mozTocH3" name="SqlServerInputFileInstall"></a>Installation</h3>

To install <code>SqlServerInputFile</code>:<br>


    
    <div style="margin-left: 40px;"><span style="text-decoration: underline;">If you will be using the
Visual Studio Web Form Designer</span>,
add the <code>SqlServerInputFile</code> control to your
toolbox. &nbsp;To do that,
right-click
on the Toolbox, click Add/Remove Items, Browse to&nbsp; 
<code>NeatUpload-1.2.x/Extensions/SqlServerInputFile/SqlServerUploader/bin/Hitone.Web.SqlServerUploader.dll</code>,
click Open, and then click
OK. &nbsp;A reference to <code>Hitone.Web.SqlServerUploader.dll</code>
will
automatically be added to your project the first time you use the
designer to a SqlServerInputFile to a form.<br>


    <span style="text-decoration: underline;">If you won't
be using the Visual Studio Web Form Designer</span>,
add a reference to your web application that refers to the <code>Hitone.Web.SqlServerUploader.dll</code>
in the <code>NeatUpload-1.</code><code>2.<span style="font-style: italic;">x</span>/Extensions/SqlServerInputFile/SqlServerUploader/bin/
    </code>directory.</div>

<h3><a class="mozTocH3" name="SqlServerInputFileConfigure"></a>Configuration</h3>

To configure your application to use the <code>SqlServerUploadStorageProvider</code>, 
add the following to your <code>Web.config</code>:<code><br>


    <br>


&lt;configuration&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;configSections&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;sectionGroup name="system.web"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;section name="neatUpload"
type="Brettle.Web.NeatUpload.ConfigSectionHandler,
Brettle.Web.NeatUpload" allowLocation="true" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/sectionGroup&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;/configSections&gt;<br>


&nbsp; &nbsp; ...<br>


    </code><code>&nbsp;&nbsp;&nbsp;
&lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;neatUpload ...<br>


    </code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;defaultProvider="SqlServerUploadStorageProvider"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&lt;providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;add name="<span style="font-style: italic;"></span></code><code>SqlServerUploadStorageProvider</code><code><span style="font-style: italic;"></span>" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp; type="<span style="font-family: monospace;">Hitone.Web.SqlServerUploader.SqlServerUploadStorageProvider, Hitone.Web.SqlServerUploader</span>"<br>

&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;connectionString="<em>connection string (required unless using connectionName to identify named connection in ASP.NET 2.0)</em>"<br>


&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;<em>options identifying stored procs or table/column names (required)</em><br>


&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;hashAlgorithm="<em>optional name of hash algorithm supported by .NET (e.g. MD5, SHA1, etc), defaults to no hash</em>"/&gt;<br>


    </code><code></code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;/providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/neatUpload&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&lt;/configuration&gt;</code><br>


<br>

<p>
The <code>SqlServerUploadStorageProvider</code> can either generate SQL itself
or use stored procedures on the database server for all tasks.  
This is controlled by the attributes you specify when you add the provider to your <code>Web.config</code>.
When the provider needs to do something, it first checks to see if you have specified a stored procedure to do it 
using one of the following attributes:
  <ul>
    <li><code>createProcedure</code> - Procedure that takes @FileName and @MIMEType (both varchars) input
      parameters, and sets @Identity (Numeric) and @Pointer (Binary(16)) output parameters.  The
      @Identity and @Pointer values that are returned will be passed to the <code>writeProcedure</code> as the file
      is received.  The @Identity value will also be passed to the <code>deleteProcedure</code>, 
      <code>cleanupProcedure</code>, <code>renameProcedure</code>, and <code>storeHashProcedure</code>.</li>
    <li><code>writeProcedure</code> - Procedure that takes @Identity 
      (Numeric), @Pointer (Binary(16)), @Offset (Int), @Delete (Int), and @Bytes (varbinary) input parameters.
      It should replace the @Delete bytes at position @Offset in the file identified by @Identity and
      @Pointer with the bytes in @Bytes.</li>
    <li><code>cleanupProcedure</code> - The provider calls this procedure with @Identity (Numeric) when an upload is
      no longer in progress and it will not call <code>writeProcedure</code> anymore.  Note that this procedure is 
      called even if the upload did not complete successfully for some reason.</li>
    <li><code>storeHashProcedure</code> - If the <code>hashAlgorithm</code> attribute is set, the provider calls 
      this procedure with @Identity (Numeric) and @Hash (varchar).  @Hash is the hash value computed for the file
      identified by @Identity.</li>
    <li><code>renameProcedure</code> - The provider calls this procedure with @Identity (Numeric) and @FileName 
      (varchar) to indicate that the application has requested that the name of the file identified by @Identity be
      changed to @FileName.  This happens when you call <code><em>inputFileId</em>.MoveTo()</code>.</li>
    <li><code>deleteProcedure</code> - Procedure that takes @Identity (Numeric) input parameter and deletes the 
      specified file.  This is called at the end of the request if your application called neither 
      <code><em>inputFileId</em>.MoveTo() nor <code><em>inputFileId</em>.Verify()</code></code></li>
    <li><code>openProcedure</code> - This procedure is called if you use
      <code><em>inputFileId</em>.FileContent</code> to access the uploaded file as a stream.  It takes
      an @Identity (Numeric) input parameter, and sets @Pointer (Binary(16)), @FileName (varchar), and @MIMEType 
      (varchar) output parameters.  The  @Pointer value that is returned will be passed to the 
      <code>readProcedure</code> as content is read from the stream.</li>
    <li><code>readProcedure</code> - This procedure is called if you use
      <code><em>inputFileId</em>.FileContent</code> to access the uploaded file as a stream.  It takes @Identity 
      (Numeric), @Pointer (Binary(16)), @Offset (Int), and @Size (Int) input parameters and returns the @Size bytes
      starting at position @Offset in the file identified by @Identity and @Pointer.</li>
  </ul>
</p>

<p>
If you don't provide a stored procedure for what the provider needs to do, it will generate the SQL to do it.  
When generating SQL queries, the provider uses the values you specify with the following attributes:
  <ul>
    <li><code>tableName</code> - Name of the table to contain the files.  "FileTable" in the example below.</li>
    <li><code>dataColumnName</code> - Name of an image/varbinary column for the contents of the uploaded file.
      "DataField" in the example below.</li>
    <li><code>partialFlagColumnName</code> - Name of a tinyint column that the provider will set to 1 while the upload
      is being received and set to 0 when the upload is complete.  "Partial" in the example below.</li>
    <li><code>fileNameColumnName</code> - Name of a nvarchar column for the name of the uploaded file.  While the
      upload is being received, the provider will set the column to the name (excluding path provided by the browser).
      If you call <em>inputFileId</em>.MoveTo(), the new name will be stored in this column.  "FileName" in the 
      example below.</li>
    <li><code>mimeTypeColumnName</code> - Name of a nvarchar column for the browser-provided MIME content type of the
      file "MimeType" in the example below.</li>
    <li><code>hashColumnName</code> - Name of a nvarchar column for the hash of the file contents (as a hex string).
      "FileHash" in the example below.</li>
  </ul>
</p>

<p>
To generate SQL queries, the provider only requires <code>tableName</code> and <code>dataColumnName</code>.  The 
remaining attributes are optional.
</p>
<p>
<strong>Note: The 
generated SQL will not work with SQL Server 2000</strong> because it requires the "$IDENTITY" object
to reference the IDENTITY column of the table. An <code>identityColumnName</code> attribute might be added in a 
future release.  Until then, SQL Server 2000 users will need to use stored procedures to workaround around this 
limitation.  
</p>

<h3><a class="mozTocH3" name="SqlServerInputFileUse"></a>Usage</h3>

To add the <code>SqlServerInputFile</code> to your forms:<br>

<ol>
  <li>
    <span style="text-decoration: underline;">If you are
using Visual Studio Web Form Designer</span>, simply drag the <code>SqlServerInputFile</code>
control from your Toolbox and drop it on the form.<br>


    <span style="text-decoration: underline;">If you are
not using Visual Studio Web Form Designer</span>, add the
following line at the top of your form:<span style="font-family: monospace;"><br>
    <br>


&lt;%@ Register TagPrefix="SqlUpload"
Namespace="Hitone.Web.SqlServerUploader"
Assembly="Hitone.Web.SqlServerUploader"%&gt;<br>


    </span><br>


and add an&nbsp;<code>SqlServerInputFile</code> control to
your
aspx page wherever you
want the user to choose a file, using something like this:
    
    <pre>&lt;SqlUpload:SqlServerInputFile id="<var>inputFileId</var>" runat="server" /&gt;<br></pre>


  </li>


  <li>Set any properties that you would normally set on an <code>InputFile
or HtmlInputFile</code> control.</li>


  <li>In your code-behind class, you can use the methods properties you would normally use on an <code>InputFile</code>
  object.  In addition, <code>SqlServerInputFile</code> offers a <code>Verify()</code>
  method that tells the <code>SqlServerUploadStorageProvider</code> not to delete the
  uploaded file at the end of the request.  <code>Verify()</code> is equivalent to calling
  <code><em>inputFileId</em>.MoveTo(<em>inputFileId</em>.FileName, MoveToOptions.Overwrite)</code> but doesn't cause the extra
  database update.
  <code>SqlServerInputFile</code> also adds <code>Hash</code>, <code>HashSize</code>, and <code>HashAlgorithm</code>
  properties which return information about the cryptographic hash (if any) computed for the uploaded file.<br>
  </li>
</ol>


<h3><a class="mozTocH3" name="SqlServerInputFileExample"></a>Example</h3>
<p>
There is a demo at <code>Extensions/SqlServerInputFile/UploaderTest/DBWrite.aspx</code>.  Before using it for the
first time, you need to:
  <ol>
    <li>Create a database named "FileStorageTest" on an SQL Server.</li>
    <li>Create the table and stored procedures by running the query below corresponding to your version of 
    SQL Server.</li>
    <li>If necessary, change the connection strings in
    <code>Extensions/SqlServerInputFile/UploaderTest/Web.config</code> to point to your database.  For example,
    if you are using SQL Server Express on your local machine, you'll need to change <code>"Server=.;"</code> to 
    <code>"Server=.\SQLEXPRESS;"</code> in several places.</li>
  </ol>
</p>

<h4>Example Setup Query for SQL Server 2005</h4>
<pre>
CREATE TABLE [FileTable] (
	[Id] [int] IDENTITY (1, 1) PRIMARY KEY NOT NULL ,
	[FileName] [nvarchar] (50) NULL,
	[DataField] [image] NOT NULL ,
	[Partial] [tinyint] NOT NULL ,
	[MimeType] [nvarchar] (50) NULL ,
	[Created] [datetime] NOT NULL CONSTRAINT [DF_FileTable_Created] DEFAULT (getdate()),
	[FileHash] [nvarchar] (50) NULL ,
)
GO

CREATE Procedure CreateBlob
	@Identity Numeric Output,
	@Pointer Binary(16) Output,
	@FileName VarChar(250) = null,
	@MIMEType VarChar(250) = null
As Begin Set NoCount ON;
	Insert Into FileTable (Datafield,FileName,MimeType,Partial) Values ('',@FileName,@MimeType,1)
	Select @Identity = SCOPE_IDENTITY()
	Select @Pointer = TEXTPTR(DataField) From FileTable Where $IDENTITY = @Identity
End

Go

CREATE Procedure OpenBlob
	@Identity Numeric,
	@Pointer VarBinary(max) Output,
	@Size Int Output,
	@FileName VarChar(250) Output,
	@MIMEType VarChar(250) Output
As Begin Set NoCount On
	Select	@Pointer = TEXTPTR(DataField), 
			@Size = DATALENGTH(DataField),
			@FileName = [FileName],
			@MIMEType = MIMEType
	From FileTable Where $IDENTITY = @Identity
End

Go

CREATE Procedure ReadBlob
	@Identity Numeric, --ignored in this implementation, here for reference
	@Pointer Binary(16),
	@Offset Int,
	@Size Int
As Begin Set NoCount On
	ReadText FileTable.DataField @Pointer @Offset @Size
End

Go

CREATE Procedure WriteBlob
	@Identity Numeric, --ignored in this implementation, here for reference
	@Pointer Binary(16),
	@Bytes VarBinary(max),
	@Offset Int,
	@Delete Int
As Begin Set NoCount On
	UpdateText FileTable.DataField @Pointer @Offset @Delete With Log @Bytes
End

Go

CREATE Procedure CleanUpBlob
	@Identity Numeric
As Begin Set NoCount On
	Update FileTable Set Partial=0 Where $Identity=@Identity
End

Go

CREATE Procedure DeleteBlob
	@Identity Numeric
As Begin Set NoCount On
	Delete From FileTable Where $Identity=@Identity
End

Go

CREATE Procedure RenameBlob
	@Identity Numeric,
	@FileName VarChar(250)
As Begin Set NoCount On
	Update FileTable Set [FileName]=@FileName Where $Identity=@Identity
End

Go

CREATE Procedure FinalizeBlob
	@Identity Numeric,
	@Hash VarChar(250)
As Begin Set NoCount On
	Update FileTable Set FileHash=@Hash Where $Identity=@Identity
End

</pre>

<h4>Example Setup Query for SQL Server 2000</h4>

<p>
The main difference between this version and the version for SQL Server 2005 is the lack of a $IDENTITY object
and the cap of 8000 bytes in a varbinary
</p>

<pre>
CREATE TABLE [FileTable] (
	[Id] [int] IDENTITY (1, 1) PRIMARY KEY NOT NULL ,
	[FileName] [nvarchar] (50) NOT NULL ,
	[DataField] [image] NOT NULL ,
	[Partial] [tinyint] NOT NULL ,
	[MimeType] [nvarchar] (50) NOT NULL ,
	[Created] [datetime] NOT NULL CONSTRAINT [DF_FileTable_Created] DEFAULT (getdate()),
	[FileHash] [nvarchar] (50) NULL ,
)

GO

CREATE Procedure CleanUpBlob
	@Identity Numeric
As Begin Set NoCount On
	Update FileTable Set Partial=0 Where Id=@Identity
End

GO

CREATE Procedure CreateBlob
	@Identity Numeric Output,
	@Pointer Binary(16) Output,
	@FileName VarChar(250) = null,
	@MIMEType VarChar(250) = null
As Begin Set NoCount ON;
	Insert Into FileTable (Datafield,FileName,MimeType,Partial) Values ('',@FileName,@MimeType,1)
	Select @Identity = SCOPE_IDENTITY()
	Select @Pointer = TEXTPTR(DataField) From FileTable Where id = @Identity
End

GO

CREATE Procedure DeleteBlob
	@Identity Numeric
As Begin Set NoCount On
	Delete From FileTable Where id=@Identity
End

GO

CREATE Procedure FinalizeBlob
	@Identity Numeric,
	@Hash VarChar(250)
As Begin Set NoCount On
	Update FileTable Set FileHash=@Hash Where id=@Identity
End

GO

CREATE Procedure OpenBlob
	@Identity Numeric,
	@Pointer VarBinary(8000) Output,
	@Size Int Output,
	@FileName VarChar(250) Output,
	@MIMEType VarChar(250) Output
As Begin Set NoCount On
	Select	@Pointer = TEXTPTR(DataField), 
			@Size = DATALENGTH(DataField),
			@FileName = [FileName],
			@MIMEType = MIMEType
	From FileTable Where id = @Identity
End

GO

CREATE Procedure ReadBlob
	@Identity Numeric, --ignored in this implementation, here for reference
	@Pointer Binary(16),
	@Offset Int,
	@Size Int
As Begin Set NoCount On
	ReadText FileTable.DataField @Pointer @Offset @Size
End

GO

CREATE Procedure RenameBlob
	@Identity Numeric,
	@FileName VarChar(250)
As Begin Set NoCount On
	Update FileTable Set [FileName]=@FileName Where id=@Identity
End

GO

CREATE Procedure WriteBlob
	@Identity Numeric, --ignored in this implementation, here for reference
	@Pointer Binary(16),
	@Bytes VarBinary(8000),
	@Offset Int,
	@Delete Int
As Begin Set NoCount On
	UpdateText FileTable.DataField @Pointer @Offset @Delete With Log @Bytes
End
</pre>


<h2><a class="mozTocH2" name="mozTocId831551"></a>The
HashedInputFile Extension</h2>


HashedInputFile is a NeatUpload extension that computes the
cryptographic hash of each uploaded file while the upload is in
progress.&nbsp; &nbsp;It consists of the <code>HashedInputFile</code>
web control&nbsp;and a custom <code>UploadStorageProvider</code>
called <code>HashingFilesystemUploadStorageProvider</code>.
&nbsp;The <code>HashedInputFile</code> control is a
subclass of <code>InputFile</code> that adds a <code>Hash</code>
property which returns the cryptographic hash of the uploaded file
computed by the <code>HashingFilesystemUploadStorageProvider</code>.
&nbsp;To use the HashedInputFile extension:<br>


<ol>


  <li>Install HashedInputFile:<br>


    
    <div style="margin-left: 40px;"><span style="text-decoration: underline;">If you will be using the
Visual Studio Web Form Designer</span>,
add the <code>HashedInputFile</code> control to your
toolbox. &nbsp;To do that,
right-click
on the Toolbox, click Add/Remove Items, Browse to&nbsp; <code>NeatUpload-1.1.x/HashedInputFile/bin/Brettle.Web.NeatUpload.HashedInputFile.dll</code>,
click Open, and then click
OK. &nbsp;A reference to <code>Brettle.Web.NeatUpload.HashedInputFile.dll</code>
will
automatically be added to your project the first time you use the
designer to a HashedInputFile to a form.<br>


    <span style="text-decoration: underline;">If you won't
be using the Visual Studio Web Form Designer</span>,
add a reference to your web application that refers to the <code>Brettle.Web.NeatUpload.HashedInputFile.dll</code>
in the <code>NeatUpload-1.</code><code>1.<span style="font-style: italic;">x</span></code><code>/HashedInputFile/bin
    </code>directory.</div>


  </li>


  <li>Configure your web application to use the <code>HashingFilesystemUploadStorageProvider</code>.
&nbsp;The simplest way to do that is to add the following to your <code>Web.config</code>
(see&nbsp;<a href="Manual.html#mozTocId221000">Configuration</a>
for more options):<code><br>


    <br>


&lt;configuration&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;configSections&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;sectionGroup name="system.web"&gt;<br>



&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &lt;section name="neatUpload"
type="Brettle.Web.NeatUpload.ConfigSectionHandler,
Brettle.Web.NeatUpload" &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;allowLocation="true" /&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/sectionGroup&gt;<br>


&nbsp;&nbsp;&nbsp; &lt;/configSections&gt;<br>


&nbsp; &nbsp; ...<br>


    </code><code>&nbsp;&nbsp;&nbsp;
&lt;system.web&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;neatUpload <br>


    </code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;defaultProvider="HashingFilesystemUploadStorageProvider"&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&lt;providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;add name="<span style="font-style: italic;"></span></code><code>HashingFilesystemUploadStorageProvider</code><code><span style="font-style: italic;"></span>" <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp; type="<span style="font-family: monospace;">Brettle.Web.NeatUpload.HashingFilesystemUploadStorageProvider,
Brettle.Web.NeatUpload.HashedInputFile</span>"<br>


&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp;algorithm="MD5"/&gt;<br>


    </code><code></code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&lt;/providers&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&lt;/neatUpload&gt;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; ...<br>


&nbsp;&nbsp;&nbsp; &lt;/system.web&gt;<br>


&nbsp;&nbsp;&nbsp; ...<br>


&lt;/configuration&gt;</code><br>


Note: the value of the&nbsp;<code>algorithm</code>
attribute above is passed to <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfsystemsecuritycryptographyhashalgorithmclasscreatetopic2.asp">HashAlgorithm.Create()</a>.
&nbsp;The default value is "MD5", so the attribute could have been
omitted above.</li>


  <li>Add the HashedInputFile to your forms:<br>


    <span style="text-decoration: underline;">If you are
using Visual Studio Web Form Designer</span>, simply drag the <code>HashedInputFile</code>
control from your Toolbox and drop it on the form.<br>


    <span style="text-decoration: underline;">If you are
not using Visual Studio Web Form Designer</span>, add the
following line at the top of your form:<span style="font-family: monospace;"><br>


    <br>


&lt;%@ Register TagPrefix="HashedUpload"
Namespace="Brettle.Web.NeatUpload"
Assembly="Brettle.Web.NeatUpload.HashedInputFile"%&gt;<br>


    </span><br>


and add an&nbsp;<code>HashedInputFile</code> control to
your
aspx page wherever you
want the user to choose a file, using something like this:
    
    <pre>&lt;HashedUpload:HashedInputFile id="<var>inputFileId</var>" runat="server" /&gt;<br></pre>


  </li>


  <li>Set any properties that you would normally set on an <code>InputFile
or HtmlInputFile</code> control.</li>


  <li>In your code-behind class,&nbsp;use the <code><span style="font-family: monospace;"><span style="font-style: italic;">inputFileId</span>.Hash</span></code>
property to get a byte array containing the cryptographic hash.
&nbsp;You can also use <span style="font-family: monospace;"><span style="font-style: italic;">inputFileId</span>.HashSize</span>
to get the number of bits in the hash (in case it isn't a multiple of
8).<br>


  </li>


</ol>


For an example of using the HashedInputFile extension, see <code>HashedInputFile/HashedDemo.aspx</code>
and <code>HashedInputFile/HashedDemo.aspx.cs</code>.
&nbsp;For a more complex configuration example, see <code>HashedInputFile/Web.config</code>.
&nbsp;It uses <a href="#mozTocId134915">location
filtering</a> and is designed to work in conjuction with the <code>Web.config</code>
in parent directory.<br>


<h2><a class="mozTocH2" name="mozTocId250326"></a>Customization</h2>


<h3><a class="mozTocH3" name="mozTocId628349"></a><a class="mozTocH3" name="Customizing_Progress_aspx"></a>Customizing
<code>Progress.aspx</code></h3>


<p> The <code>Progress.aspx</code> page that comes
with NeatUpload is just an
example. You can modify it to suit your needs. &nbsp;For example,
you
could change the color scheme with minor modification to the
<code>default.css</code> stylesheet that is included, or
you could change the text
or images that are used by modifying <code>Progress.aspx</code>
itself. &nbsp;You could
even rearrange the layout entirely or create a new page derived from <code>ProgressPage</code>
and use the <code>Url</code> property of the <code>ProgressBar</code>
to refer to it. &nbsp;To allow AJAX refreshless updates, you must
include at least one <code>DetailsSpan</code> or <code>DetailsDiv</code>
control. &nbsp;Those controls render as like <code>div</code>
and <code>span</code> controls, respectively.
&nbsp;Use data-binding expressions within those
controls (either the in the content or properties) to access the
details of the upload at runtime.&nbsp; Below is a list of the
properties and methods that NeatUpload provides for use in data-binding
expressions. &nbsp; Refer to the default <code>Progress.aspx</code>
for an example of how each of these is used. </p>


<table border="1">


  <thead><tr>


    <td><strong>Name</strong></td>


    <td><strong>Description</strong></td>


  </tr>


  </thead> <tbody>


    <tr>


      <td><code>Status</code></td>


      <td>A value from the <code>UploadStatus</code>
enumeration, as follows:<br>


      <code>Unknown</code> - NeatUpload has not yet started
receiving the upload<br>


      <code>NormalInProgress</code> - a normal
(non-chunked) upload had started but not yet finished<br>


      <code>ChunkedInProgress</code> - an upload which uses
chunked transfer coding has started but not yet finished.<br>


      <code>Completed</code> - the entire upload
was&nbsp;successfully received<br>


      <code>Cancelled</code> - the user has cancelled the
upload using the cancel link<br>


      <code>Rejected</code> - the upload has been rejected
by the server because it is unacceptable for some reason<br>


      <code>Failed</code> - an unexpected error occurred
while receiving the upload<br>


      <br>


If the <code>WhenStatus</code> property of a <code>DetailsSpan</code>
and <code>DetailsDiv</code> control is set, the control
will only render when the status is one of the space-separated list of
statuses in the <code>WhenStatus</code> value.
&nbsp;If the <code>WhenStatus</code> property is not
set, the control will always display.</td>


    </tr>


    <tr>


      <td><code>BytesRead</code></td>


      <td>Number of bytes received by the server so far.
&nbsp;Pass this to <code>FormatCount()</code> to get a
more readable value.<br>


      </td>


    </tr>


    <tr>


      <td><code>BytesTotal</code></td>


      <td>Total number of bytes in the upload. &nbsp;Pass
this to <code>FormatCount()</code> to get a more readable
value. &nbsp;For chunked uploads, <code>BytesTotal</code>
is -1.</td>


    </tr>


    <tr>


      <td><code>CountUnits</code></td>


      <td>The units associated with the result of a call to <code>FormatCount()</code>.
&nbsp;&nbsp;If&nbsp;<code>BytesTotal</code> is
greater that 1 million, returns the value of the <code>MBUnits</code>
resource. &nbsp;Otherwise, if&nbsp;<code>BytesTotal</code>
is greater than 1
thousand,&nbsp;returns the value of the <code>KBUnits</code>
resource.
&nbsp;Otherwise, returns the value of the <code>ByteUnits</code>
resource. &nbsp;Note: for chunked uploads, <code>BytesRead</code>
is used instead of <code>BytesTotal</code>.</td>


    </tr>


    <tr>


      <td><code>FormatCount(long count)</code></td>


      <td>Converts a number of bytes to units that would make <code>BytesTotal</code>
readable. &nbsp;If <code>BytesTotal</code> is greater
that 1 million,&nbsp;<code>count</code> is formatted
according to the <code>MBCountFormat</code> resource.
&nbsp;Otherwise, if&nbsp;<code>BytesTotal</code>
greater than 1 thousand,&nbsp;<code>count</code> is
formatted according to the <code>KBCountFormat</code>
resource. &nbsp;Otherwise, <code>count</code> is
formatted according of the <code>ByteCountFormat</code>
resource. &nbsp;Note: for chunked uploads, <code>BytesRead</code>
is used instead of <code>BytesTotal</code>.</td>


    </tr>


    <tr>


      <td><code>BytesPerSec</code></td>


      <td>Rate (in bytes/sec) at which the server has received
the
upload. &nbsp; While the upload is in progress, this is an average
over
the past 1-2 seconds. &nbsp;When the upload has finished, this is
an
average over the entire upload.<br>


      </td>


    </tr>


    <tr>


      <td><code>FormatRate(int rate)</code></td>


      <td>Converts a rate to more readable units. &nbsp;If <code>rate</code>
is greater than 1 million, it is formatted according to the <code>MBRateFormat</code>
resource. &nbsp;Otherwise, if&nbsp;<code>rate</code>
is
greater than 1 thousand, it is formatted according to the <code>KBRateFormat</code>
resource. &nbsp;Otherwise,&nbsp;<code>rate</code>
is formatted according of the <code>ByteRateFormat</code>
resource.</td>


    </tr>


    <tr>


      <td><code>FractionComplete</code></td>


      <td>A double in the range 0.0-1.0. &nbsp;Computed as <code>BytesRead</code>/<code>BytesTotal</code>
for normal (ie non-chunked) uploads. &nbsp;Always 0.0 for chunked
uploads.<br>


      </td>


    </tr>


    <tr>


      <td><code>TimeElapsed</code></td>


      <td><code>TimeSpan</code> representing the time
that has elapsed since the upload began.<br>


      </td>


    </tr>


    <tr>


      <td><code>TimeRemaining</code></td>


      <td><code>TimeSpan</code> estimating the time
left until the
upload completes. &nbsp;This is projected based on the elapsed time
and
the fraction complete. &nbsp;Returns <code>TimeSpan</code>.<code>MaxValue</code>
if <code>BytesRead</code> is 0 or if this is a chunked
upload. </td>


    </tr>


    <tr>


      <td><code>FormatTimeSpan(</code><code>TimeSpan</code>
ts<code>)</code></td>


      <td>Formats a <code>TimeSpan</code> for
readability using the following code:<br>


      <code>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;string format;<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; if (ts.TotalSeconds &lt; 60)<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; format =
GetResourceString("SecondsFormat");<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; else if (ts.TotalSeconds &lt; 60*60)<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; format =
GetResourceString("MinutesFormat");<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; else<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; format =
GetResourceString("HoursFormat");<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; return String.Format(format,<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(int)Math.Floor(ts.TotalHours),<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
(int)Math.Floor(ts.TotalMinutes),<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ts.Seconds,<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ts.TotalHours,<br>
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
ts.TotalMinutes);</code></td>


    </tr>


    <tr>


      <td><code>Rejection</code></td>


      <td>An <code>UploadException</code> (eg <code>UploadTooLargeException</code>)
when <code>Status</code> is <code>Rejected</code>.
&nbsp;Otherwise, <code>null</code>. &nbsp;It can
be useful to display <code>Rejection.Message</code> to the
user when a rejection occurs. &nbsp;NeatUpload throws an <code>UploadTooLargeException</code>
if the total request size is more than the size specified with the <code>maxRequestLength</code>
attribute of the <code>&lt;neatUpload&gt;</code>
element. &nbsp;The value of the <code>UploadTooLargeException</code>'s
      <code>Message</code> property is based on the <code>UploadTooLargeMessageFormat</code>
resource in <code>Strings.resx</code>.</td>


    </tr>


    <tr>


      <td><code>Failure</code></td>


      <td>An&nbsp;<code>Exception</code>&nbsp;
when <code>Status</code> is <code>Failed</code>.
&nbsp;Otherwise, <code>null</code>. &nbsp;It can
be useful to display <code>Failure.Message</code> to the
user when a failure occurs.</td>


    </tr>


    <tr>


      <td><code>CurrentFileName</code></td>


      <td>The client-specified name of the file currently being
received by the server. &nbsp;</td>


    </tr>


    <tr>


      <td><code>CancelVisible</code></td>


      <td>Whether the 'cancel' link should be visible.
&nbsp;This is
only 'true' when an upload is in progress and NeatUpload can use
JavaScript to cancel an upload.</td>


    </tr>


    <tr>


      <td><code>StartRefreshVisible</code></td>


      <td>Whether the 'start refresh' link should be visible.
&nbsp;This is only 'true' when the progress display is not
refreshing
and NeatUpload can't use JavaScript to automatically start refreshing
it when the upload starts. &nbsp;</td>


    </tr>


    <tr>


      <td><code>StopRefreshVisible</code></td>


      <td>Whether the 'stop refresh' link should be visible.
&nbsp;This is only
'true' when the upload is in progress, the progress display is
refreshing, and NeatUpload can't
use Javascript to cancel the upload.</td>


    </tr>


    <tr>


      <td><code>CancelUrl, </code><code>StartRefreshUrl.&nbsp;</code><code>StopRefreshUrl</code></td>


      <td>The URLs for the 'cancel', 'start refresh', and 'stop
refresh' links, respectively.</td>


    </tr>


  
  </tbody>
</table>


<br>


By default, <code>ProgressPage</code> calls it's <code>GetResourceString()</code>
method to retrieve all of it's resources. &nbsp;The default
implementation uses the embedded resources compiled from <code>Strings.resx</code>.
&nbsp;If you want to use a different source, override <code>GetResourceString()</code>
in your subclass.
<p>For AJAX refreshless updates to work, your <code>ProgressPage</code>
subclass must render as a well-formed XML document. &nbsp;Here are
a few tips to avoid the most common problems:</p>


<ul>


  <li>Use all lowercase for HTML element names (ie '<code>&lt;body&gt;</code>'
instead of '<code>&lt;BODY&gt;</code>' or '<code>&lt;Body&gt;</code>').</li>


  <li>If your page contains HTML-specific entities replace them
with their numeric equivalents. &nbsp;For example, replace '<code>&amp;nbsp;</code>'
with '<code>&amp;#160;</code>'.</li>


  <li>Use <code>&lt;asp:HyperLink&gt;</code>
instead of <code>&lt;a&gt;</code> for links,
especially for links that use <code>CancelUrl</code>, <code>StartRefreshUrl</code>,
and <code>StopRefreshUrl</code>. &nbsp;Some&nbsp;<code>HtmlAnchor</code>&nbsp;(i.e.
    <code>&lt;a&gt;</code>) implementations,
notably Microsoft's ASP.NET 2.0, do not HTML encode the value of the <code>href</code>
attribute. &nbsp;If the URLs contain ampersands, the XML will not
be considered well-formed unless they are encoded.</li>


</ul>


One final note: By default,&nbsp;<code>DetailsDiv</code>
and <code>DetailsSpan</code> controls (like regular <code>div</code>
and <code>span</code> controls) will not render as simple <code>&lt;div&gt;</code>
and <code>&lt;span&gt;</code> elements in browsers
that ASP.NET considers "downlevel". &nbsp;Instead, <code>div</code>
controls are rendered as tables and <code>span</code>
controls may render with extra font tags, etc. &nbsp;The <code>Machine.config</code>
shipped with ASP.NET 1.1 contains a <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpgenref/html/gngrfbrowsercapssection.asp"><code>&lt;browserCaps&gt;</code></a>
section that causes all non-IE browsers to be considered downlevel,
including Netscape, Firefox, Opera, Safari, etc. &nbsp;To force the
<code>DetailsDiv</code> and <code>DetailsSpan</code>
controls to render as simple <code>&lt;div&gt;</code>
and <code>&lt;span&gt;</code> elements even in
supposedly downlevel browsers, set the control's <code>UseHtml4</code>
property to "true". &nbsp;The default <code>Progress.aspx</code>
does that for the <code>DetailsDiv</code> control with an
id of "barDetailsDiv" that is used to draw the gray progress bar.
&nbsp;Note that even with the <code>UseHtml4</code>
property it is still a good idea to <a href="http://slingfive.com/pages/code/browserCaps/">update
or supplement the default ASP.NET 1.1 <code>&lt;browserCaps&gt;</code>
section</a> to make the rest of your web application render more
cleanly in modern non-IE browsers.
<ul>


</ul>


<h3><a class="mozTocH3" name="mozTocId184279"></a>Creating
Custom Fallback Content for <code>ProgressBar</code></h3>


<p> If JavaScript is not available or the browser doesn't support
IFRAMEs and the <code>ProgressBar</code> element is empty,
a "Check Upload Progress"
link will be displayed. To change the text of that link, simply place
the desired text (or controls) between the begin and end tags of the
<code>ProgressBar</code> element. For example: </p>


<pre>	&lt;Upload:ProgressBar id="progressBar" runat="server" &gt;<br>	&lt;asp:Label id="label" runat="server" Text="Your Text Here"/&gt;<br>	&lt;/Upload:ProgressBar&gt;</pre>


<h3><a class="mozTocH3" name="mozTocId759939"></a>Creating
a Custom UploadStorageProvider</h3>


By default, NeatUpload uses the built-in
<code>FilesystemUploadStorageProvider</code> which streams
uploaded files to a
temporary directory until you move them. &nbsp;If you would rather
stream uploaded files to some other location (e.g. a database, or
remote machine), or you want some other functionality not provided
by&nbsp;<code>FilesystemUploadStorageProvider,</code>
you need to
create and use a custom <code>UploadStorageProvider</code>.
&nbsp;To create a
custom <code>UploadStorageProvider</code>, create a class
which inherits from
<code>UploadStorageProvider</code>. &nbsp;You will need
to implement the following
methods:<br>


<br>


<code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; public abstract void Initialize(string
name, NameValueCollection attrs);<br>


<br>


</code><code>&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; public virtual&nbsp; UploadedFile
CreateUploadedFile(UploadContext ctx, <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string
controlUniqueID, <br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; string
fileName,<br>


&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
&nbsp;string contentType,<br>


&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
&nbsp; &nbsp;
UploadStorageConfig storageConfig);<br>


</code><br>


When the configuration section where your provider is added is first
relevant to a request, NeatUpload creates an
instance of your provider and calls it's <code>Initialize()</code>
method,
&nbsp;passing the value of the "name" attribute as the first
parameter and the remaining attributes (other than "name", and "type")
as the second parameter. &nbsp;You can use the remaining attributes
to pass provider-specific configuration information to your provider.<br>


<br>


Whenever NeatUpload encounters a file upload associated with an
<code>InputFile</code> control, it calls the<code></code>
second
<code>CreateUploadedFile()</code>
method of the provider that is configured as the <code>defaultProvider</code>
for the requested page. &nbsp;When NeatUpload calls your provider's
<code>CreateUploadedFile()</code> method, it passes the <code>UploadContext</code>
associated with the current request, the ID of the <code>InputFile</code>
control
associated with the upload, the browser-specified name and MIME
type of the file, and the value of the InputFile control's <code>StorageConfig</code>
property. &nbsp;<code>CreateUploadedFile()</code>
is responsible for
returning an instance of a class derived from <code>UploadedFile</code>.
&nbsp;NeatUpload will stream the file to that object, and delegate
various <code>InputFile</code> members to the associated
methods of your
<code>UploadedFile</code>-derived object.<br>


<br>


Your provider's <code>CreateUploadedFile()</code> can
optionally use the <code>ContentLength</code> property of
the passed <code>UploadContext</code> to get the length of
the entire request, including all files. &nbsp;That information
could be used to reserve sufficient space to store the files, for
example. &nbsp;At the moment, no members of <code>UploadContext</code>
other than <code>ContentLength</code> are available to
providers. &nbsp;Future releases of NeatUpload might use
UploadContext to pass other similar information to providers.<br>


<br>


Your provider can "reject" an upload at any time (eg based on MIME
type, size, or content), by throwing an exception derived from <code>UploadException</code>.
&nbsp;When NeatUpload detects such an exception, it:<br>


<ol>


  <li>updates the progress bar to indicate that the upload was
rejected (i.e. sets <code>Status</code> to <code>Rejected</code>
and <code>Rejection</code> to the <code>UploadException</code>
that occured)</li>


  <li>if the progress bar is in a pop-up window, leaves the
pop-up open so that the user can see the message</li>


  <li>asks the browser to stop the upload using javascript to
simulate clicking the browser's Stop button</li>


  <li>waits 5 seconds to give the browser and opportunity to stop
the upload</li>


  <li>rethrows
the exception</li>


</ol>


NeatUpload has no way of knowing for sure whether the browser stopped
the upload, so it always rethrows the exception. &nbsp;If the
browser did stop the upload, it will ignore any response that the
application generates because of the error. &nbsp;If the browser
didn't stop the upload, it will display the response that the
application generates. &nbsp;You can customize that response by
handling the <code>Application.Error</code> event or by
using custom error pages. &nbsp;<code>UploadException</code>
is a subclass of <code>HttpException</code>, so you can
control which custom error page is used by specifying the corresponding
HTTP error code when you construct your <code>UploadException</code>.<br>


<br>


When NeatUpload detects an exception that is <span style="font-style: italic;">not</span> derived from <code>UploadException</code>,
it assumes that it is an unexpected error, so it:<br>


<ol>


  <li>updates the progress bar to indicate that an error
occurred&nbsp;(i.e. sets <code>Status</code> to <code>Failed</code>
and <code>Failure</code> to the&nbsp;<code>Exception</code>
that occured)</li>


  <li>if the progress bar is in a pop-up window, leaves the
pop-up open so that the user can see the message</li>


  <li>rethrows the exception</li>


</ol>


ASP.NET will handled the exception the same way any other exception is
handled. &nbsp;It will fire the <code>Application.Error</code>
event and use custom error pages if they are configured.<br>


<br>


If the <code>NameValueCollection</code> provided by <code>UploadStorageConfig</code>
is not sufficient for your provider, you can override <code>UploadStorageProvider.CreateUploadStorageConfig()</code>
to return your own <code>UploadStorageConfig</code>
subclass. &nbsp;Your subclass can override the <code>UploadStorageConfig.Serialize(Stream)</code>
and <code>UploadStorageConfig.Deserialize(Stream)</code>
methods to serialize itself to the provided <code>Stream</code>
and deserialize itself from the provided <code>Stream</code>.
&nbsp;The base class implementations of these methods use <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/cpref/html/frlrfSystemWebUILosFormatterClassTopic.asp"><code>LosFormatter</code></a>
to provide a concise serialization of the <code>NameValueCollection</code>
as a <code>Hashtable</code>.<br>


<br>


For an example of how to implement a custom <code>UploadStorageProvider</code>,
see <code>FilesystemUploadStorageProvider.cs</code> and <code>FilesystemUploadedFile.cs</code>.
&nbsp; For another example, see the files in the <code>HashedInputFile</code>
directory.<br>
<h3><a class="mozTocH3" name="mozTocId614710"></a>Handling Non-absolute Paths in IE6</h3>
If instead of selecting a file to upload via the file selection
dialog, an IE6 user types in a non-absolute path (e.g. just "x"), IE6
will not submit the form, no upload will occur, and NeatUpload will not
start the progress display. &nbsp;Unfortunately, this means that the
user gets no feedback to indicate what the problem is. &nbsp;If you
want to provide feedback, NeatUpload provides a hook for that purpose.
&nbsp;When NeatUpload detects this situation, it checks to see if a
JavaScript function named NeatUpload_HandleIE6InvalidPath() exists.
&nbsp; If it exists, NeatUpload calls that function, passing it the
input file form element that contains the non-absolute path.
&nbsp;NeatUpload does not provide an implementation of that function by
default, but you can provide your own implementation. &nbsp;For
example, your implementation might display "Invalid path" next to the
input file form element so that the user knows what the problem is.
<p>Since users almost always use the file selection dialog, this issue almost never arises.</p>


<h2><a class="mozTocH2" name="mozTocId580088"></a>Known
Issues</h2>
<h3><a class="mozTocH3" name="IIS7"></a>NeatUpload does not work in IIS7's default application pool</h3>

<p>Due to <a href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=308352">a
bug in IIS7's Integrated Pipeline Mode</a>, NeatUpload will not work in IIS7's default application pool.
To workaround this, you need to configure your web site to use the "Classic .NET AppPool".  To
encourage Microsoft to fix the bug in a future IIS release, please 
<a href="https://connect.microsoft.com/VisualStudio/feedback/ViewFeedback.aspx?FeedbackID=308352">give 5 stars
to it</a>.  For more information on the issue,
please see <a href="http://forums.iis.net/p/1132368/1802914.aspx">the discussion with IIS7 Program Manager Mike 
Volodarsky</a>.
</p>
<h3><a class="mozTocH3" name="AspNetTrace"></a>ASP.NET application-wide tracing disables NeatUpload</h3>

<p>When ASP.NET tracing is enabled in the application Web.config, ASP.NET reads the entire upload before
NeatUpload can access it.  As a result, NeatUpload can't stream the upload
to storage and can't provide a meaningful progress bar.  Since NeatUpload can't do anything useful under such
circumstances, it automatically disables itself.  Specifically, it acts as though you set the 
<code>useHttpModule</code> attribute of the <code>&lt;neatUpload&gt;</code> element to "false".  That prevents
display of the progress bar and prevents streaming to storage, but your code should otherwise continue to function
normally.
</p>

<p>Note that this issue only arises when you enable <i>application-wide</i> ASP.NET tracing (i.e. via the
Web.config).  It does not arise if you only enable ASP.NET tracing at the page level using the <code>Trace</code>
attribute of the <code>&lt;%@Page%&gt;</code> directive.  Unfortunately, if you enable 
application-wide ASP.NET tracing but disable tracing for some or all pages using the
<code>Trace</code> attribute of the <code>&lt;%@Page%&gt;</code> directive, the problem still occurs.  This is
because the <code>Trace</code> attribute of the <code>&lt;%@Page%&gt;</code> directive has no effect on whether
ASP.NET reads in the entire request before NeatUpload can access it.
</p>

<h3><a class="mozTocH3" name="WebGardenIssue"></a><code>ProgressBar</code> doesn't work with web gardens/farms</h3>


<p>NeatUpload maintains information about the upload in the application state of the web application 
receiving the upload request.  Since application state is not shared across instances of the web 
application, the <code>ProgressBar</code> will not be able to determine the state of the upload if the
requests it makes go to a different instance of the web application.  This can happen if you are running a
web garden (i.e. multiple worker processes) or a web farm (i.e. multiple web servers).  To ensure that you
are not running a web garden, see Microsoft's documentation on 
<a href="http://www.microsoft.com/technet/prodtechnol/WindowsServer2003/Library/IIS/659f2e2c-a58b-4770-833b-df96cabe569e.mspx?mfr=true">Configuring Web Gardens with IIS 6</a>.
For high volume sites, you might be able to use a web farm if you are able to ensure that all requests from a 
particular client are routed to the same server (i.e. sticky IP).</p>


<h3><a class="mozTocH3" name="Permissions"></a>Permissions on uploaded files depends on temporary directory</h3>

<p>
Uploaded files are created in a temporary directory and inherit the permissions of that directory.  Calling
<code>InputFile.MoveTo()</code> does not change the permissions.  In some environments, files in the default
temporary directory are not readable by web applications, and as a result uploaded files are not readable
by the web application.  To avoid this issue, simply <a href="#mozTocId905959">change the temporary
directory used by NeatUpload</a> to a directory that has the permissions you desire.
</p>

<h3><a class="mozTocH3" name="UploadHttpModuleFirst"></a>Module conflicts can cause data length is shorter 
than Content-Length errors</h3>
<p>
When certain 3rd-party HttpModules are used along with NeatUpload a "Data length (xxx) is shorter than 
Content-Length (yyy) error" can occur.  To avoid this place NeatUpload's UploadHttpModule <em>first</em>
in the &lt;httpModules&gt; section, before all other modules.  This problem has been reported with both 
<a href="http://www.snapsis.com/PageBlaster.aspx">PageBlaster</a> and 
<a href="http://www.ifinity.com.au/Products/Url_Master_DNN_SEO_Urls/">UrlMaster</a>.
It is often encountered on sites that installed NeatUpload as part of 
<a href="http://www.bizmodules.net/Products/UltraVideoGallery2/Overview/tabid/124/Default.aspx">Ultra
Video Gallery (UVG)</a>.
</p>
<p>
This issue is caused by the fact that NeatUpload (and any other module that monitors upload progress) needs to
intercept the request before ASP.NET reads the request body.  ASP.NET needs to read the request body in order
to compute certain properties of the Request object (e.g. Request.Params).  So if another module accesses
one of those properties before NeatUpload intercepts the request, ASP.NET will read the request body and when
NeatUpload tries to read the request body, there won't be anything there.
</p>

<h3><a class="mozTocH3" name="ProgressBarViewState"></a><code>InvalidOperationException</code> when using <code>ProgressBar</code> 
      with <code>EnableViewState="false"</code></a></h3>
<p>
In order to start the progress display only if client-side validation succeeds and the form is submitted to the
server, NeatUpload needs to register an onsubmit statement that executes after other onsubmit statements such as
those that do client-side validation.  Most controls (e.g. validators) register their onsubmit statements during the
<code>PreRender</code> event.  To ensure that NeatUpload's onsubmit statement is executed later, it needs to be
registered after <code>PreRender</code> handlers have been called, but before <code>Render()</code> is 
called.  The <code>PreRenderComplete</code> event would be an good candidate, but unfortunately it is not available
in .NET 1.1.  Instead, NeatUpload registers its onsubmit statement in
<code>ProgressBar.SaveViewState()</code>.  Unfortunately, ASP.NET does not call <code>SaveViewState()</code>
if <code>EnableViewState</code> is "false" for the page.  To avoid silent failure when viewstate is disabled,
<code>ProgressBar.Render()</code> throws an <code>InvalidOperationException</code> if the onsubmit 
statement was not registered.
</p>
<p>
If you see the <code>InvalidOperationException</code> error thrown from <code>ProgressBar.Render()</code>, 
the simplest workaround is to enable viewstate for the page containing the <code>ProgressBar</code>.  However, if that is
not desirable, you can explicitly call <code>ProgressBar's</code> <code>RegisterOnSubmitStatement()</code> method
after other <code>PreRender</code> handlers.  Under .NET 2.0 you can add it as a <code>PreRenderComplete</code>
event handler like this:<br/>
<pre>PreRenderComplete += new System.EventHandler(progressBar.RegisterOnSubmitStatement);
</pre>
Under .NET 1.1, you can override <code>Page.OnPreRender()</code> like this:<br/>
<pre>protected override void OnPreRender(EventArgs e)
{
    base.OnPreRender(e);
    progressBar.RegisterOnSubmitStatement(null, null);
}
</pre>
</p>     

<h3><a class="mozTocH3" name="mozTocId766780"></a><code>HttpResponse.AppendToLog()</code>
does nothing when <code>UploadHttpModule</code> is used</h3>


<p>Due to the design of NeatUpload this bug will not be fixed,
however NeatUpload does provide a workaround. &nbsp;Simply replace <code>Response.AppendToLog()</code>
with <code>Brettle.Web.NeatUpload.UploadHttpModule.AppendToLog()</code>.
&nbsp;That will work whether the <code>UploadHttpModule</code>
is used or not.</p>


<h3><a class="mozTocH3" name="HeaderEncoding"></a>Setting <code>HttpResponse.HeaderEncoding</code>
does nothing when <code>UploadHttpModule</code> is used</h3>


<p>Due to the design of NeatUpload this bug will not be fixed,
however if the pages that need to set <code>Response.HeaderEncoding</code> are not pages to which 
the user will be uploading files, you can use <a href="#mozTocId134915">location filtering</a> to 
disable the <code>UploadHttpModule</code> for those pages.  Also, if you are setting 
<code>Response.HeaderEncoding</code> so that you can specify a non-ASCII 
filename for a downloaded file via the filename parameter of the Content-Disposition header,
you should consider other approaches.  Even without the 
<code>UploadHttpModule</code>, setting <code>Response.HeaderEncoding</code> will only work if you 
set it to the encoding that the browser happens to be using.  For example, setting it to "big5" will
not cause the file to have a name with Chinese characters if the user is using
the UTF-8 encoding.  Also, if you set <code>Response.HeaderEncoding</code> to a value that is different
from the encoding used by the browser, you could create a security hole.
</p>
<p>There are two better approaches.  For both approaches, the filename needs to be encoded using the
<code>HttpUtility.UrlPathEncode()</code> method.  That encodes non-ASCII characters using the %XX 
notation you often see in URLs.  Once you have the UrlPathEncoded filename, you have 2 options.
</p>
<ul>
<li>Option 1:  Set the Content-Disposition header to simply "attachment", and place the encoded 
filename in the "path info" part of the download URL.  So, instead of using a download URL of 
"http://tempuri.org/DownloadFile.ashx",
you would use a download URL of "http://tempuri.org/DownloadFile.ashx/<i>YourUrlPathEncodedFilename</i>".  
If you are using IIS or some other webserver that supports path info, this approach will work
under at least the latest versions of IE, Firefox, Opera, and Safari.  However, this approach does
not work if you are using Visual Studio's Development Web Server because it doesn't support path info.
If your server does support path info, you can implement this approach easily by changing your download 
page to redirect the browser to a page which has the necessary path info, like this:
<pre>
&lt;%@ WebHandler Language="C#" Class="Handler" %&gt;
using System;
using System.Web;

public class Handler : IHttpHandler {
    public void ProcessRequest (HttpContext context) 
    {
        string filename = &quot;&#20013;&#25991;&#27284;&#21517;.doc&quot; //  or some other file name
        string encodedFilename = HttpUtility.UrlPathEncode(filename);
        if (context.Request.PathInfo == null || context.Request.PathInfo.Length == 0)
        {
            string query = context.Request.Url.Query;
            context.Response.Redirect(context.Request.Path + &quot;/&quot; + encodedFilename + query);
        }
        else
        {
            context.Response.Clear();
    	    context.Response.ContentType = &quot;application/octet-stream&quot;;
            context.Response.AddHeader(&quot;Content-Disposition&quot;, &quot;attachment&quot;);
            FileInfo fi = new FileInfo(context.Server.MapPath(filename));
            context.Response.WriteFile(fi.FullName);
            context.Response.Flush();
            context.Response.End();
        }
    }
    
    public bool IsReusable { get { return false; } }
}
</pre>
</li>

<li>Option 2:  Set the Content-Disposition header's filename parameter to the UrlPathEncoded filename,
but do so in a way that is supported by the browser.  According to 
<a href="http://www.faqs.org/rfcs/rfc2231.html">RFC 2231</a>, the correct way to do this
is to set the Content-Disposition header to "<code>attachment;&nbsp;filename*=utf-8''<i>YourUrlPathEncodedFilename</i></code>".
That works for the latest versions of Firefox and Opera, but not IE and Safari.  Both IE and Safari 
will ignore the filename parameter and use the name of your download page (e.g. DownloadFile.ashx).  
There is no way to set the filename parameter to work with Safari, but for IE you can set Content-Disposition header to 
"<code>attachment;&nbsp;filename=<i>YourUrlPathEncodedFilename</i></code>".  That doesn't work for Firefox or Safari though.
So, you need to treat it as a special IE-only case.  Here is an example:
<pre>
<pre>
&lt;%@ WebHandler Language="C#" Class="Handler" %&gt;
using System;
using System.Web;

public class Handler : IHttpHandler {
    public void ProcessRequest (HttpContext context) 
    {
        string filename = &quot;&#20013;&#25991;&#27284;&#21517;.doc&quot; //  or some other file name
        string encodedFilename = HttpUtility.UrlPathEncode(filename);
        context.Response.Clear();
	    context.Response.ContentType = &quot;application/octet-stream&quot;;
        string contentDisposition = &quot;attachment&quot;;
        if (context.Request.Browser.IsBrowser(&quot;IE&quot;))
            contentDisposition += &quot;; filename=&quot; + encodedFilename;
        else
            contentDisposition += &quot;; filename*=utf-8''&quot; + encodedFilename;
        context.Response.AddHeader(&quot;Content-Disposition&quot;, contentDisposition);
        FileInfo fi = new FileInfo(context.Server.MapPath(filename));
        context.Response.WriteFile(fi.FullName);
        context.Response.Flush();
        context.Response.End();
    }
    
    public bool IsReusable { get { return false; } }
}
</pre>
</pre>
</li>
</ul>

<h3><a class="mozTocH4" name="mozTocId752771"></a>Inline
<code>ProgressBars </code>don't work with Opera</h3>


<p>Opera does not seem to allow an <code>IFRAME</code>
to be updated
during form submission. &nbsp;NeatUpload works around this by using
a
popup progress bar whenever the User-Agent header contains "Opera"
(case-insensitive).  Most browsers don't allow popups to be smaller that 500x100 pixels.  
If you specify a smaller width or height or use units other than pixels, NeatUpload will automatically use the
minimum size in pixels.</p>
<h3><a class="mozTocH3" name="mozTocId181845"></a>Non-absolute path in IE7 causes the progress display to start even though no upload occurs</h3>
<p>If instead of selecting a file to upload via the file selection
dialog, the user types in a non-absolute path (e.g. just "x"), IE6 and
IE7 will not submit the form and no upload will occur. &nbsp;Under IE6,
it is possible to detect this situation and prevent the progress
display from starting. &nbsp;The situation is detected by using
Javascript to examine the value of the <code>&lt;input type="file"&gt;</code>
form element. &nbsp;If the value doesn't look like an absolute path,
the progress display is not started. &nbsp;In IE7, the value of the
form element is always just the filename, not the full path, probably
for security reasons. &nbsp;As a result, NeatUpload can't prevent the
progress display from starting because it's not possible to determine
whether an absolute path was entered -- the value is "x" whether the
user entered "x" or "c:\x".</p>
<p>Since users almost always use the file selection dialog, this issue almost never arises.</p>

<h3><a class="mozTocH3" name="OnClickReturnValue"></a>Handler returning false does not block default action in IE6</h3>
<p>
When not using NeatUpload, an event handler returning false will prevent the browser from performing the default action
for the event.  For example, consider a submit button with <code>onclick="return&nbsp;confirm('Submit?');"</code>.
If the user clicks the button a dialog will appear asking "Submit?".  When not using NeatUpload, declining will
prevent submission of the form.  However, when using NeatUpload, the 
form will be submitted if the user is using IE6.  To workaround this, change such handlers to set 
<code>window.event.returnValue=false</code> when they return false.  For example, here is the implementation
of a function that can be used instead of <code>confirm()</code> in the above example:

<pre>
function confirmSubmit(msg)
{
    var confirmed = confirm(msg);
    if (!confirmed &amp;&amp; window.event)
        window.event.returnValue = false;
    return confirmed;
}
</pre>

</p>
<p>
This problem is caused by a difference in the order IE6 calls event handlers.  In order to prevent non-triggers
from starting an upload, NeatUpload registers event handlers on the <code>&lt;form&gt;</code> element for a variety
of events (including onclick).  Those handlers clear the filename if the event is not coming from a trigger.  In 
standard-conformant browsers (i.e. modern browsers other than IE), it is possible to register those handlers so that
they run before other handlers registered for controls within the form (e.g. submit buttons).  As a result, the value
returned by the submit button handler is what determines whether the form actually gets submitted.  In IE, the 
NeatUpload form event handler runs last and the value it returns (always true) determines whether the form gets 
submitted.  NeatUpload can't determine the value returned by the submit button handler and return it instead, 
so the above workaround is needed.  
</p>
<h3><a class="mozTocH3" name="MacIELinkButtons"></a><code>LinkButtons</code> do not start the progress display in Internet Explorer 
for the Mac</h3>
<p>
NeatUpload overrides the <code>form.submit()</code> JavaScript method to start the progress display when the 
form is submitted programmatically (e.g. with a <code>LinkButton</code>).  Mac IE does not support overriding 
<code>form.submit()</code> so NeatUpload can't start the progress display if a <code>LinkButton</code> is used to
submit the form.  The upload still occurs though.  Since Mac IE is no longer supported by Microsoft and currently
has less than 1% of the browser market, there are currently no plans to develop a workaround for this.
</p>

<h3><a class="mozTocH3" name="LargeResponseNotBuffered"></a>Sometimes responses larger than 1MB are not buffered</h3>
<p>
Without NeatUpload, ASP.NET (by default) buffers the entire response in memory before sending it.  However, 
when NeatUpload's <code>UploadHttpModule</code> is installed, it will sometimes
flush the buffer if the response is larger than 1 MByte.  Responses smaller then 1 MBytes are not affected,
but NeatUpload will sometimes flush 
larger responses even if the page does not contain any NeatUpload controls and does not receive uploads.  
To avoid this behavior you need to use <a href="#mozTocId134915">location
filtering</a> to set <code>&lt;neatUpload ... useHttpModule="true".../&gt;</code> for the page.
Very few applications need to buffer such large 
responses, but if your application needs such buffering, you can use 
location filtering to workaround the issue.
</p>
<p>
Technical note: The current behavior is a side-effect of a workaround for a problem where
<code>HttpResponse.TransmitFile()</code>
was causing the entire file to be buffered in memory when the <code>UploadHttpModule</code> was being used.  
Apparently, Microsoft coded <code>TransmitFile()</code> so that buffering is only avoided when the
current <code>HttpWorkerRequest</code> is a particular subclass of <code>HttpWorkerRequest</code>.  Since NeatUpload
wraps the original <code>HttpWorkerRequest</code> in it's own subclass, ASP.NET does not see the original
<code>HttpWorkerRequest</code> and does not bypass the buffering.  Instead it calls 
<code>HttpWorkerRequest.SendResponseFromFile()</code>.  NeatUpload's implementation of 
<code>SendResponseFromFile()</code> avoids the problem by flushing the response after every 1 MByte.  
Since this workaround affects <code>SendResponseFromFile()</code> but not other methods of sending response content,
the flushing will not occur for all types of responses.  That means you should not assume a response will be
flushed simply because it is larger than 1 MByte.  
</p>

<h2><a class="mozTocH2" name="mozTocId405545"></a>Troubleshooting</h2>


<p>If you think NeatUpload's <code>UploadHttpModule</code>
might be causing a problem, the first thing you should do is set the <code>&lt;neatUpload&gt;</code>
element's&nbsp;<code>useHttpModule</code> attribute
to&nbsp;"false" (or remove the <code>UploadHttpModule</code>
from the <code>&lt;httpModules&gt;</code> section)
and try to reproduce the problem. &nbsp;All of your existing code
should continue to work - you just won't get progress bars and
streaming of files to disk. &nbsp;If the problem goes away when you
remove the <code>UploadHttpModule</code>, it is a bug so
please <a href="http://www.brettle.com/neatupload_bugs">report
it</a>. &nbsp;You can help me diagnosis the problem by doing
the following:</p>


<ol>


  <li>Set the <code>debugDirectory</code> attribute
of the <code>&lt;neatUpload&gt;</code> element in
your <code>Web.config</code> to the name
of a directory in your webapp where NeatUpload can store copies of the
request bodies it processes. &nbsp;For example,<code>
&lt;neatUpload ... debugDirectory="MyDebugDir" ...&gt; </code>would
cause NeatUpload to store copies of the request bodies in the
"MyDebugDir" directory under you application root.</li>


  <li>Reproduce the problem.</li>


  <li>Send me (dean at brettle dot com) a zip file containing the
files
from debug directory with the extensions ".body" and ".sizes".
&nbsp;Each ".body" file contains the body of a request you sent
when
reproducing the problem. &nbsp;The corresponding ".sizes" file
contains
the MIME type of the request and the size of each chunk that NeatUpload
read. &nbsp;I can use the <code>TestFilter.exe</code>
program to reproduce how the <code>UploadHttpModule</code>
processed the request and (hopefully) determine exactly what went wrong.</li>


</ol>


<p>&nbsp;NeatUpload is
capable of logging debug and error messages using&nbsp;log4net,
but that capability is disabled by default to simplify installation and
use of NeatUpload. &nbsp;To enable logging with <a href="http://logging.apache.org/log4net/">log4net</a>:</p>


<ol>


  <li>If your web application is not already using log4net:</li>


  
  <ol>


    <li><a href="http://logging.apache.org/log4net/downloads.html">Download</a>
and <a href="http://logging.apache.org/log4net/release/building.html">build</a>
log4net.</li>


    <li>Add a reference to your web application that refers to
the log4net.dll you built.</li>


    <li>Copy <code>NeatUpload-1.1.<span style="font-style: italic;">x</span>/log4net.config</code>
to the root directory of your web application.</li>


    <li>Add the following line to your <code>Global.asax.cs</code>&nbsp;before
the <code>namespace</code> keyword: <br>


      <br>


      <code>[assembly:
log4net.Config.XmlConfigurator(ConfigFile="log4net.config", Watch=true)]</code><br>


      <br>


or if you are using VB.NET, add the following to your Global.asax.vb:<br>


      <br>


      <code>&lt;assembly:
log4net.Config.XmlConfigurator(ConfigFile:="log4net.config",
Watch:=true)&gt;<br>


      </code></li>


  
  </ol>


  <li>Add a reference to the NeatUpload project that refers to
log4net.dll.</li>


  <li>Change the properties/options for the NeatUpload project
to define USE_LOG4NET.</li>


  <li>Rebuild NeatUpload. </li>


  
  <ol>


  
  </ol>


</ol>


<ol>


</ol>


</body>
</html>
